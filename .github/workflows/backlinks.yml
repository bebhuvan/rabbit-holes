name: AI Backlinks

on:
  push:
    paths:
      - 'src/content/posts/**/*.md'
    branches:
      - master

jobs:
  backlinks:
    runs-on: ubuntu-latest
    # Don't run on commits from this action
    if: "!contains(github.event.head_commit.message, '[skip-backlinks]') && !contains(github.event.head_commit.message, 'Add backlinks')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed posts
        id: changed
        run: |
          # Get list of added/modified markdown files in posts
          CHANGED=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD -- 'src/content/posts/*.md' || echo "")
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          if [ -n "$CHANGED" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Process backlinks
        if: steps.changed.outputs.has_changes == 'true'
        env:
          SITE_URL: ${{ vars.SITE_URL || 'https://rabbitholes.garden' }}
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: |
          # Process each changed file
          echo "$CHANGED_FILES" | while read -r file; do
            if [ -z "$file" ]; then continue; fi
            echo "Processing: $file"

            # Check if file exists and doesn't already have related_posts
            if [ -f "$file" ]; then
              # Extract frontmatter to check for existing related_posts
              HAS_RELATED=$(node -e "
                const fs = require('fs');
                const content = fs.readFileSync(process.argv[1], 'utf8');
                const match = content.match(/^---\n([\s\S]*?)\n---/);
                if (match) {
                  const hasRelated = match[1].includes('related_posts:');
                  console.log(hasRelated ? 'yes' : 'no');
                } else {
                  console.log('no');
                }
              " "$file")

              if [ "$HAS_RELATED" = "no" ]; then
                echo "Finding related posts for: $file"

                # Create a Node script to extract data and call API
                node -e "
                  const fs = require('fs');
                  const https = require('https');
                  const http = require('http');

                  const filePath = process.argv[1];
                  const siteUrl = process.argv[2];

                  const content = fs.readFileSync(filePath, 'utf8');

                  // Parse frontmatter
                  const fmMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)/);
                  if (!fmMatch) {
                    console.log('No frontmatter found');
                    process.exit(0);
                  }

                  const frontmatter = fmMatch[1];
                  const body = fmMatch[2].substring(0, 1500);

                  // Extract fields
                  const titleMatch = frontmatter.match(/title:\s*[\"']?([^\"'\n]+)[\"']?/);
                  const title = titleMatch ? titleMatch[1].trim() : '';

                  const typeMatch = frontmatter.match(/type:\s*(\w+)/);
                  const type = typeMatch ? typeMatch[1] : 'musings';

                  const tagsMatch = frontmatter.match(/tags:\n((?:\s+-\s+.+\n?)*)/);
                  let tags = [];
                  if (tagsMatch) {
                    const tagLines = tagsMatch[1].match(/-\s+(.+)/g);
                    if (tagLines) {
                      tags = tagLines.map(t => t.replace(/-\s+/, '').replace(/[\"']/g, '').trim());
                    }
                  }

                  console.log('Title:', title);
                  console.log('Type:', type);
                  console.log('Tags:', tags);

                  // Call API
                  const postData = JSON.stringify({ title, type, tags, content: body });
                  const url = new URL(siteUrl + '/api/find-related');

                  const options = {
                    hostname: url.hostname,
                    port: url.port || (url.protocol === 'https:' ? 443 : 80),
                    path: url.pathname,
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Content-Length': Buffer.byteLength(postData)
                    }
                  };

                  const proto = url.protocol === 'https:' ? https : http;
                  const req = proto.request(options, (res) => {
                    let data = '';
                    res.on('data', chunk => data += chunk);
                    res.on('end', () => {
                      try {
                        const json = JSON.parse(data);
                        const related = json.related || json.relatedToNew || [];
                        console.log('Related posts:', related);

                        if (related.length > 0) {
                          // Update file with related_posts
                          const relatedYaml = 'related_posts:\n' + related.map(r => {
                            if (typeof r === 'string') {
                              return '  - \"' + r + '\"';
                            }
                            return '  - slug: \"' + r.slug + '\"\n    reason: \"' + (r.reason || '').replace(/\"/g, \"'\") + '\"';
                          }).join('\n') + '\n';

                          const newContent = '---\n' + frontmatter + '\n' + relatedYaml + '---\n' + fmMatch[2];
                          fs.writeFileSync(filePath, newContent);
                          console.log('Updated file with related posts');
                        }
                      } catch (e) {
                        console.error('Error parsing response:', e.message);
                      }
                    });
                  });

                  req.on('error', (e) => {
                    console.error('Request error:', e.message);
                  });

                  req.write(postData);
                  req.end();
                " "$file" "$SITE_URL"
              else
                echo "Skipping $file - already has related_posts"
              fi
            fi
          done

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --staged --quiet || git commit -m "Add backlinks to new posts [skip-backlinks]"
          git push
