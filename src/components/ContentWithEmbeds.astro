---
// Content renderer with automatic embed processing
import YouTubeEmbed from './YouTubeEmbed.astro';
import VimeoEmbed from './VimeoEmbed.astro';
import TwitterEmbed from './TwitterEmbed.astro';
import CodePenEmbed from './CodePenEmbed.astro';
import SpotifyEmbed from './SpotifyEmbed.astro';
import LinkPreviewDynamic from './LinkPreviewDynamic.astro';

export interface Props {
  post: any;
}

const { post } = Astro.props;

// Helper functions to extract IDs from URLs
function getYouTubeId(url: string): string | undefined {
  if (!url) return undefined;
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
    /youtube\.com\/watch\?.*v=([^&\n?#]+)/
  ];
  
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) return match[1];
  }
  
  return undefined;
}

function getVimeoId(url: string): string | undefined {
  if (!url) return undefined;
  const match = url.match(/vimeo\.com\/(?:.*\/)?(\d+)/);
  return match ? match[1] : undefined;
}

function getCodePenId(url: string): string | undefined {
  if (!url) return undefined;
  const match = url.match(/codepen\.io\/[^\/]+\/pen\/([^\/\?]+)/);
  return match ? match[1] : undefined;
}

// Check if URL should be embedded
function shouldEmbed(url: string): { type: string; id?: string } | null {
  if (!url) return null;
  try {
    const hostname = new URL(url).hostname.toLowerCase();
  
  if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {
    const id = getYouTubeId(url);
    return { type: 'youtube', id };
  }
  
  if (hostname.includes('vimeo.com')) {
    const id = getVimeoId(url);
    return { type: 'vimeo', id };
  }
  
  if (hostname.includes('twitter.com') || hostname.includes('x.com')) {
    return { type: 'twitter' };
  }
  
  if (hostname.includes('codepen.io')) {
    const id = getCodePenId(url);
    return { type: 'codepen', id };
  }
  
  if (hostname.includes('spotify.com')) {
    return { type: 'spotify' };
  }
  
  return { type: 'generic' };
  } catch {
    return null;
  }
}

// Simply render the content - embeds are now handled by the remark plugin
const { Content: PostContent } = await post.render();
---

<div class="content-with-embeds">
  <PostContent />
</div>

<script>
  // Client-side enhancement for link previews
  document.addEventListener('DOMContentLoaded', async () => {
    // Find all link preview placeholders
    const linkPreviews = document.querySelectorAll('.link-preview-placeholder[data-url]');
    
    for (const placeholder of linkPreviews) {
      const url = placeholder.getAttribute('data-url');
      if (!url) continue;
      
      try {
        // Fetch link preview data from the server
        const response = await fetch('/api/metadata', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.title || data.description || data.image) {
            // Create a proper link preview
            placeholder.innerHTML = `
              <a href="${url}" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit; display: block;">
                <div style="display: flex; gap: 1rem; align-items: start;">
                  ${data.image ? `
                    <img src="${data.image}" alt="" style="width: 120px; height: 120px; object-fit: cover; border-radius: 4px; flex-shrink: 0;">
                  ` : ''}
                  <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                      ${data.title || url}
                    </div>
                    ${data.description ? `
                      <div style="font-size: 0.9em; color: var(--color-text-secondary, #666); margin-bottom: 0.25rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                        ${data.description}
                      </div>
                    ` : ''}
                    <div style="font-size: 0.85em; color: var(--color-text-tertiary, #999); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                      ${new URL(url).hostname}
                    </div>
                  </div>
                </div>
              </a>
            `;
          }
        }
      } catch (e) {
        console.warn('Failed to fetch link preview:', e);
        // Keep the basic preview on error
      }
    }
  });
</script>

<style>
  .content-with-embeds {
    /* Ensure proper spacing between content and embeds */
  }
  
  .detected-embeds {
    margin-top: var(--space-2xl);
  }
  
  .detected-embeds > * {
    margin-bottom: var(--space-2xl);
  }
  
  .detected-embeds > *:last-child {
    margin-bottom: 0;
  }
  
  .content-with-embeds :global(.standalone-url) {
    margin: var(--space-xl) 0;
    padding: var(--space-lg);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-align: center;
  }
</style>