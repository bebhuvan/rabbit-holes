---
export const prerender = true;

import { getCollection } from 'astro:content';
import Base from '../../layouts/Base.astro';
import Comments from '../../components/Comments.astro';
import { calculateReadingTime } from '../../utils/shared';
import { getRelatedPostsForBuild } from '../../utils/buildRelatedPosts';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => {
    return data.published !== false;
  });

  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const readingTime = calculateReadingTime(post.body || '');

// Get all posts for related posts algorithm
const allPosts = await getCollection('posts', ({ data }) => {
  return data.published !== false;
});

// Get related posts from frontmatter first
const manualRelated = (post.data.related_posts || []).map((r: string | { slug: string }) =>
  typeof r === 'string' ? r : r.slug
);
const reasons: Record<string, string> = {};
(post.data.related_posts || []).forEach((r: string | { slug: string; reason?: string }) => {
  if (typeof r === 'object' && r.reason) {
    reasons[r.slug] = r.reason;
  }
});

// If no manual related posts, use AI-powered build-time generation
let displayRelatedPosts: Array<{post: any, reason: string | null}> = [];

if (manualRelated.length > 0) {
  // Use manual frontmatter entries
  displayRelatedPosts = manualRelated
    .map((slug: string) => allPosts.find(p => p.slug === slug))
    .filter(Boolean)
    .slice(0, 3)
    .map((p: any) => ({
      post: p,
      reason: reasons[p.slug] || null
    }));
} else {
  // Use AI-powered related posts (cached)
  const postData = {
    slug: post.slug,
    title: post.data.title,
    body: post.body || '',
    tags: post.data.tags || [],
    type: post.data.type || 'musings',
    date: post.data.date.toISOString()
  };
  const allPostData = allPosts.map(p => ({
    slug: p.slug,
    title: p.data.title,
    body: p.body || '',
    tags: p.data.tags || [],
    type: p.data.type || 'musings',
    date: p.data.date.toISOString()
  }));

  const aiRelated = await getRelatedPostsForBuild(postData, allPostData);
  displayRelatedPosts = aiRelated
    .map(r => ({
      post: allPosts.find(p => p.slug === r.slug),
      reason: r.reason
    }))
    .filter(item => item.post);
}

// Helper to determine post type
function getPostType(p: any) {
  const type = p.data.type || '';

  if (type === 'musings') {
    return { label: 'Musing', color: 'var(--orange)' };
  }
  if (type === 'links') {
    return { label: 'Links', color: 'var(--blue)' };
  }
  if (type === 'reflections') {
    return { label: 'Reflection', color: 'var(--color-text-primary)' };
  }
  if (type === 'verse') {
    return { label: 'Verse', color: 'var(--purple)' };
  }
  if (type === 'practical') {
    return { label: 'Practical', color: 'var(--green)' };
  }
  return { label: 'Post', color: 'var(--orange)' };
}

const postType = getPostType(post);

// Extract external links from post body for "Connected Ideas"
function extractLinks(body: string): Array<{url: string, text: string, domain: string}> {
  const linkRegex = /\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g;
  const links: Array<{url: string, text: string, domain: string}> = [];
  let match;

  while ((match = linkRegex.exec(body || '')) !== null) {
    const url = match[2];
    const text = match[1];
    try {
      const domain = new URL(url).hostname.replace('www.', '');
      // Skip common image/media links
      if (!url.match(/\.(jpg|jpeg|png|gif|webp|svg|mp4|mp3)$/i)) {
        links.push({ url, text, domain });
      }
    } catch {
      // Invalid URL, skip
    }
  }

  // Dedupe by URL and limit to 6
  const seen = new Set<string>();
  return links.filter(l => {
    if (seen.has(l.url)) return false;
    seen.add(l.url);
    return true;
  }).slice(0, 6);
}

const externalLinks = extractLinks(post.body || '');

// Structured data for SEO
const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.data.title,
  "description": post.data.description || `A ${post.data.type} post about ${post.data.title}`,
  "author": {
    "@type": "Person",
    "name": "Bhuvan",
    "url": "https://www.rabbitholes.garden/about"
  },
  "datePublished": post.data.date,
  "dateModified": post.data.date,
  "publisher": {
    "@type": "Organization",
    "name": "Rabbit Holes",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.rabbitholes.garden/favicon.svg"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://www.rabbitholes.garden/posts/${post.slug}`
  },
  "keywords": post.data.tags?.join(', ') || '',
  "articleSection": post.data.type
};
---

<Base
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
>
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)}></script>

  <article class="post-page">

    <header class="post-header">
      <a href="/" class="back-link">‚Üê Home</a>

      <div class="post-meta">
        <span class="post-type" style={`color: ${postType.color}`}>{postType.label}</span>
        <span class="meta-sep">¬∑</span>
        <time class="post-date">
          {new Date(post.data.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
        </time>
        <span class="meta-sep">¬∑</span>
        <span class="reading-time">{readingTime} min read</span>
      </div>

      <h1 class="post-title">{post.data.title}</h1>

      {post.data.description && (
        <p class="post-subtitle">{post.data.description}</p>
      )}

      {post.data.tags && post.data.tags.length > 0 && (
        <div class="post-tags">
          {post.data.tags.map((tag: string) => (
            <a href={`/tags/${tag}`} class="tag">{tag}</a>
          ))}
        </div>
      )}

      {post.data.url && (
        <div class="source-attribution">
          <a href={post.data.url} target="_blank" rel="noopener noreferrer" class="source-link">
            <img
              src={`https://www.google.com/s2/favicons?domain=${new URL(post.data.url).hostname}&sz=32`}
              alt=""
              class="source-favicon"
              width="16"
              height="16"
              loading="lazy"
            />
            <span class="source-domain">{new URL(post.data.url).hostname.replace('www.', '')}</span>
            <span class="source-arrow">‚Üó</span>
          </a>
          {post.data.via && (
            <span class="via-attribution">
              ¬∑ via {post.data.via.startsWith('http') ? (
                <a href={post.data.via} target="_blank" rel="noopener noreferrer">
                  {post.data.via.includes('twitter.com') || post.data.via.includes('x.com')
                    ? '@' + post.data.via.split('/').pop()
                    : new URL(post.data.via).hostname.replace('www.', '')}
                </a>
              ) : post.data.via}
            </span>
          )}
        </div>
      )}
    </header>

    <div class="post-content">
      <Content />
    </div>

    <!-- Share Section -->
    <div class="share-section">
      <div class="section-label">Share this</div>
      <div class="share-buttons">
        <button class="share-btn" id="share-twitter">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
          Twitter
        </button>
        <button class="share-btn" id="share-linkedin">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
          </svg>
          LinkedIn
        </button>
        <button class="share-btn" id="share-copy">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
          </svg>
          Copy link
        </button>
      </div>
    </div>

    {externalLinks.length > 0 && (
      <div class="links-section">
        <div class="section-label">üîó Connected ideas</div>
        <div class="external-links">
          {externalLinks.map((link) => (
            <a href={link.url} class="external-link" target="_blank" rel="noopener noreferrer">
              <span class="link-text">{link.text}</span>
              <span class="link-domain">{link.domain} ‚Üó</span>
            </a>
          ))}
        </div>
      </div>
    )}

    {displayRelatedPosts.length > 0 && (
      <div class="related-section">
        <div class="section-label">üêá Keep falling...</div>
        <div class="related-posts">
          {displayRelatedPosts.map(({ post: relatedPost, reason }, i) => {
            const colors = ['orange', 'purple', 'blue'];
            return (
              <a href={`/posts/${relatedPost.slug}`} class="related-post" data-color={colors[i]}>
                <span class="related-num">{String(i + 1).padStart(2, '0')}</span>
                <div class="related-content">
                  <h3 class="related-title">{relatedPost.data.title}</h3>
                  {reason && <span class="related-reason">{reason}</span>}
                  <span class="related-meta">
                    {calculateReadingTime(relatedPost.body || '')} min ¬∑ {relatedPost.data.tags?.[0] || 'musings'}
                  </span>
                </div>
                <span class="related-arrow">‚Üí</span>
              </a>
            );
          })}
        </div>
      </div>
    )}

    <Comments
      pageId={post.slug}
      pageUrl={`https://www.rabbitholes.garden/posts/${post.slug}`}
      pageTitle={post.data.title}
    />

  </article>

  <style>
    .post-page {
      max-width: 700px;
      margin: 0 auto;
      padding: 0 2rem 4rem;
    }

    /* Header */
    .post-header {
      padding: 3rem 0 2.5rem;
      border-bottom: 3px solid var(--color-text-primary);
    }

    .back-link {
      font-family: 'Space Mono', monospace;
      font-size: 0.68rem;
      font-weight: 700;
      color: var(--color-text-tertiary);
      text-decoration: none;
      display: inline-block;
      margin-bottom: 2rem;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: var(--orange);
    }

    .post-meta {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
    }

    .post-type {
      font-family: 'Space Mono', monospace;
      font-size: 0.62rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .meta-sep {
      color: var(--color-text-light);
      font-size: 0.8rem;
    }

    .post-date,
    .reading-time {
      font-family: 'Space Mono', monospace;
      font-size: 0.68rem;
      color: var(--color-text-tertiary);
    }

    .post-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: clamp(2rem, 6vw, 2.75rem);
      font-weight: 700;
      line-height: 1.1;
      letter-spacing: -0.03em;
      margin-bottom: 1rem;
      color: var(--color-text-primary);
    }

    .post-subtitle {
      font-family: 'Newsreader', Georgia, serif;
      font-size: 1.2rem;
      line-height: 1.6;
      color: var(--color-text-secondary);
      font-style: italic;
      margin-bottom: 1.5rem;
    }

    .post-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .tag {
      font-family: 'Space Mono', monospace;
      font-size: 0.62rem;
      font-weight: 700;
      padding: 0.4rem 0.7rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      text-decoration: none;
      transition: all 0.2s;
    }

    .tag:hover {
      background: var(--color-text-primary);
      color: var(--color-bg);
    }

    /* Source Attribution */
    .source-attribution {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1.25rem;
      padding: 0.75rem 1rem;
      background: var(--color-surface);
      border-radius: 6px;
      font-family: 'Space Mono', monospace;
      font-size: 0.75rem;
    }

    .source-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--color-text-secondary);
      text-decoration: none;
      transition: color 0.2s;
    }

    .source-link:hover {
      color: var(--orange);
    }

    .source-favicon {
      border-radius: 2px;
    }

    .source-domain {
      font-weight: 600;
    }

    .source-arrow {
      opacity: 0.5;
    }

    .via-attribution {
      color: var(--color-text-tertiary);
    }

    .via-attribution a {
      color: var(--color-text-secondary);
      text-decoration: none;
    }

    .via-attribution a:hover {
      color: var(--orange);
    }

    /* Content */
    .post-content {
      font-family: 'Newsreader', Georgia, serif;
      font-size: 1.2rem;
      line-height: 1.8;
      color: var(--color-text-secondary);
      padding-top: 3rem;
    }

    .post-content :global(p) {
      margin-bottom: 1.75rem;
    }

    .post-content :global(a) {
      color: var(--color-text-primary);
      text-decoration: underline;
      text-decoration-color: rgba(217, 93, 15, 0.4);
      text-decoration-thickness: 1.5px;
      text-underline-offset: 3px;
      transition: text-decoration-color 0.2s;
    }

    .post-content :global(a:hover) {
      text-decoration-color: var(--orange);
    }

    .post-content :global(h2) {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1.3;
      margin-top: 3rem;
      margin-bottom: 1rem;
      letter-spacing: -0.02em;
      color: var(--color-text-primary);
    }

    .post-content :global(h3) {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.25rem;
      font-weight: 600;
      line-height: 1.35;
      margin-top: 2.5rem;
      margin-bottom: 0.75rem;
      color: var(--color-text-primary);
    }

    .post-content :global(ul),
    .post-content :global(ol) {
      margin-bottom: 1.75rem;
      padding-left: 1.5rem;
    }

    .post-content :global(li) {
      margin-bottom: 0.5rem;
    }

    .post-content :global(li::marker) {
      color: var(--orange);
    }

    .post-content :global(blockquote) {
      margin: 2.5rem 0;
      padding: 0 0 0 1.5rem;
      border-left: 3px solid var(--orange);
      font-style: italic;
      color: var(--color-text-primary);
    }

    .post-content :global(blockquote p) {
      margin: 0 0 1rem 0;
    }

    .post-content :global(blockquote p:last-child) {
      margin-bottom: 0;
    }

    .post-content :global(strong) {
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .post-content :global(code) {
      font-family: 'Space Mono', monospace;
      font-size: 0.9em;
      background: var(--color-surface);
      padding: 0.15em 0.4em;
    }

    .post-content :global(pre) {
      background: var(--color-surface);
      padding: 1.25rem;
      overflow-x: auto;
      margin-bottom: 1.75rem;
    }

    .post-content :global(pre code) {
      background: none;
      padding: 0;
    }

    .post-content :global(img) {
      max-width: 100%;
      height: auto;
      margin: 2.5rem 0;
    }

    .post-content :global(hr) {
      border: none;
      height: 1px;
      background: var(--color-border);
      margin: 3rem 0;
    }

    /* Share Section */
    .share-section {
      margin-top: 4rem;
      padding-top: 2rem;
      border-top: 1px solid var(--color-border);
    }

    .section-label {
      font-family: 'Space Mono', monospace;
      font-size: 0.58rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--color-text-light);
      margin-bottom: 1rem;
    }

    .share-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .share-btn {
      font-family: 'Space Mono', monospace;
      font-size: 0.68rem;
      font-weight: 700;
      padding: 0.75rem 1.25rem;
      border: 2px solid var(--color-border);
      background: transparent;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .share-btn:hover {
      background: var(--color-text-primary);
      color: var(--color-bg);
      border-color: var(--color-text-primary);
    }

    .share-btn.copied {
      background: var(--green);
      color: white;
      border-color: var(--green);
    }

    /* Connected Ideas - External Links */
    .links-section {
      margin-top: 4rem;
      padding-top: 2rem;
      border-top: 1px solid var(--color-border);
    }

    .external-links {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }

    .external-link {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      padding: 1rem;
      background: var(--color-surface);
      text-decoration: none;
      transition: all 0.2s;
    }

    .external-link:hover {
      background: var(--color-surface-warm);
      transform: translateY(-2px);
    }

    .link-text {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--color-text-primary);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      transition: color 0.2s;
    }

    .external-link:hover .link-text {
      color: var(--blue);
    }

    .link-domain {
      font-family: 'Space Mono', monospace;
      font-size: 0.55rem;
      color: var(--color-text-light);
    }

    @media (max-width: 600px) {
      .external-links {
        grid-template-columns: 1fr;
      }
    }

    /* Related Section - "Keep falling..." */
    .related-section {
      margin-top: 4rem;
      padding-top: 2.5rem;
      border-top: 3px solid var(--color-text-primary);
    }

    .related-posts {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .related-post {
      display: grid;
      grid-template-columns: 40px 1fr 28px;
      align-items: center;
      gap: 1rem;
      padding: 1.25rem 0;
      border-bottom: 1px solid var(--color-border);
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .related-post:last-child {
      border-bottom: none;
    }

    .related-post:hover {
      padding-left: 0.5rem;
    }

    .related-num {
      font-family: 'Newsreader', Georgia, serif;
      font-size: 0.9rem;
      font-style: italic;
      color: var(--color-text-light);
      transition: color 0.2s;
    }

    .related-post[data-color="orange"]:hover .related-num { color: var(--orange); }
    .related-post[data-color="purple"]:hover .related-num { color: var(--purple); }
    .related-post[data-color="blue"]:hover .related-num { color: var(--blue); }

    .related-content {
      min-width: 0;
    }

    .related-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      line-height: 1.35;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
      transition: color 0.2s;
    }

    .related-post[data-color="orange"]:hover .related-title { color: var(--orange); }
    .related-post[data-color="purple"]:hover .related-title { color: var(--purple); }
    .related-post[data-color="blue"]:hover .related-title { color: var(--blue); }

    .related-meta {
      font-family: 'Space Mono', monospace;
      font-size: 0.65rem;
      color: var(--color-text-light);
    }

    .related-arrow {
      font-size: 1.1rem;
      color: var(--color-text-light);
      opacity: 0;
      transform: translateX(-4px);
      transition: all 0.2s ease;
    }

    .related-post:hover .related-arrow {
      opacity: 1;
      transform: translateX(0);
    }

    .related-post[data-color="orange"]:hover .related-arrow { color: var(--orange); }
    .related-post[data-color="purple"]:hover .related-arrow { color: var(--purple); }
    .related-post[data-color="blue"]:hover .related-arrow { color: var(--blue); }

    /* Responsive */
    @media (max-width: 768px) {
      .post-page {
        padding: 0 1.5rem 3rem;
      }

      .post-header {
        padding: 2rem 0 2rem;
      }

      .post-meta {
        gap: 0.4rem;
      }

      .post-title {
        font-size: clamp(1.75rem, 7vw, 2.25rem);
      }

      .post-subtitle {
        font-size: 1.1rem;
      }

      .post-content {
        font-size: 1.1rem;
        padding-top: 2.5rem;
      }

      .post-content :global(h2) {
        font-size: 1.35rem;
      }

      .post-content :global(h3) {
        font-size: 1.15rem;
      }

      .share-buttons {
        flex-direction: column;
      }

      .share-btn {
        justify-content: center;
      }
    }
  </style>

  <script>
    const postTitle = document.querySelector('.post-title')?.textContent || '';
    const postUrl = window.location.href;

    document.getElementById('share-twitter')?.addEventListener('click', () => {
      const text = encodeURIComponent(postTitle);
      const url = encodeURIComponent(postUrl);
      window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'width=550,height=420');
    });

    document.getElementById('share-linkedin')?.addEventListener('click', () => {
      const url = encodeURIComponent(postUrl);
      window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank', 'width=550,height=420');
    });

    document.getElementById('share-copy')?.addEventListener('click', async () => {
      const btn = document.getElementById('share-copy');
      try {
        await navigator.clipboard.writeText(postUrl);
        if (btn) {
          btn.textContent = '‚úì Copied!';
          btn.classList.add('copied');
          setTimeout(() => {
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Copy link';
            btn.classList.remove('copied');
          }, 2000);
        }
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  </script>
</Base>
