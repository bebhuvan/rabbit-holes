---
export const prerender = true;

import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';
import { generateGraphData } from '../utils/graphData';

const posts = await getCollection('posts', ({ data }) => data.published !== false);
const graphData = generateGraphData(posts);

// Get unique types for filter
const types = [...new Set(posts.map(p => p.data.type))];
---

<Base title="Knowledge Graph — Rabbit Holes" description="Explore connections between posts in the digital garden">
  <div class="graph-page">
    <header class="graph-header">
      <a href="/" class="back-link">← Back to Rabbit Holes</a>
      <div class="header-content">
        <h1>Knowledge Graph</h1>
        <p class="graph-subtitle">
          <span class="stat">{graphData.nodes.length}</span> ideas ·
          <span class="stat">{graphData.edges.length}</span> connections
        </p>
      </div>
    </header>

    <div class="graph-layout">
      <aside class="graph-sidebar">
        <div class="sidebar-section">
          <h3>Filter by Type</h3>
          <div class="type-filters">
            <button class="type-btn active" data-type="all">
              <span class="type-dot" style="background: linear-gradient(135deg, #D95D0F, #2563EB, #9333EA);"></span>
              All
            </button>
            <button class="type-btn" data-type="musings">
              <span class="type-dot" style="background: #D95D0F;"></span>
              Musings
            </button>
            <button class="type-btn" data-type="links">
              <span class="type-dot" style="background: #2563EB;"></span>
              Links
            </button>
            <button class="type-btn" data-type="reflections">
              <span class="type-dot" style="background: #6B7280;"></span>
              Reflections
            </button>
            <button class="type-btn" data-type="verse">
              <span class="type-dot" style="background: #9333EA;"></span>
              Verse
            </button>
            <button class="type-btn" data-type="practical">
              <span class="type-dot" style="background: #15803D;"></span>
              Practical
            </button>
          </div>
        </div>

        <div class="sidebar-section">
          <h3>Show Connections</h3>
          <label class="toggle-label">
            <input type="checkbox" id="showRelated" checked />
            <span class="toggle-text">Related posts</span>
            <span class="toggle-line" style="background: #D95D0F;"></span>
          </label>
          <label class="toggle-label">
            <input type="checkbox" id="showTags" checked />
            <span class="toggle-text">Shared tags</span>
            <span class="toggle-line" style="background: rgba(255,255,255,0.2);"></span>
          </label>
        </div>

        <div class="sidebar-section">
          <h3>Controls</h3>
          <p class="help-text">Drag to move nodes. Scroll to zoom. Click a node for details.</p>
          <button id="resetView" class="reset-btn">Reset View</button>
        </div>
      </aside>

      <main class="graph-main">
        <div id="graph-container" class="graph-container">
          <svg id="graph-svg"></svg>
          <div class="graph-overlay"></div>
        </div>
      </main>
    </div>

    <div id="node-details" class="node-details hidden">
      <button class="close-details" id="closeDetails">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
          <path d="M1 1L13 13M1 13L13 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <div class="detail-header">
        <span class="detail-type" id="detail-type"></span>
        <h3 id="detail-title"></h3>
      </div>
      <div id="detail-tags" class="detail-tags"></div>
      <div id="detail-connections" class="detail-connections"></div>
      <a id="detail-link" href="" class="detail-cta">
        Read this post
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M3 8H13M13 8L8 3M13 8L8 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>
  </div>

  <script define:vars={{ graphData }}>
    import('https://esm.sh/d3@7').then(d3 => {
      initGraph(d3, graphData);
    });

    function initGraph(d3, data) {
      const container = document.getElementById('graph-container');
      const svg = d3.select('#graph-svg');

      let width = container.clientWidth;
      let height = Math.max(600, window.innerHeight - 200);

      svg.attr('width', width).attr('height', height);

      // Beautiful color palette
      const typeColors = {
        musings: '#F97316',
        links: '#3B82F6',
        reflections: '#6B7280',
        verse: '#A855F7',
        practical: '#22C55E'
      };

      // Add gradient definitions for subtle glow effect
      const defs = svg.append('defs');

      // Radial gradient for node glow (lighter for light background)
      Object.entries(typeColors).forEach(([type, color]) => {
        const gradient = defs.append('radialGradient')
          .attr('id', `glow-${type}`)
          .attr('cx', '50%').attr('cy', '50%').attr('r', '50%');
        gradient.append('stop').attr('offset', '0%').attr('stop-color', color).attr('stop-opacity', 0.25);
        gradient.append('stop').attr('offset', '100%').attr('stop-color', color).attr('stop-opacity', 0);
      });

      const g = svg.append('g');

      // Zoom behavior
      const zoom = d3.zoom()
        .scaleExtent([0.3, 3])
        .on('zoom', (event) => g.attr('transform', event.transform));
      svg.call(zoom);

      // Force simulation
      const simulation = d3.forceSimulation(data.nodes)
        .force('link', d3.forceLink(data.edges)
          .id(d => d.id)
          .distance(d => d.type === 'related' ? 100 : 150)
          .strength(d => d.type === 'related' ? 0.4 : 0.05))
        .force('charge', d3.forceManyBody().strength(-200))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(30));

      // Draw edges
      const link = g.append('g')
        .attr('class', 'links')
        .selectAll('line')
        .data(data.edges)
        .join('line')
        .attr('class', d => `edge edge-${d.type}`)
        .attr('stroke', d => d.type === 'related' ? '#F97316' : 'rgba(0,0,0,0.08)')
        .attr('stroke-opacity', d => d.type === 'tag' ? 0.4 : 0.6)
        .attr('stroke-width', d => d.type === 'related' ? 1.5 : 0.5);

      // Node groups
      const node = g.append('g')
        .attr('class', 'nodes')
        .selectAll('g')
        .data(data.nodes)
        .join('g')
        .attr('class', 'node')
        .style('cursor', 'pointer')
        .call(d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended));

      // Glow circles (larger, behind)
      node.append('circle')
        .attr('class', 'node-glow')
        .attr('r', d => 12 + Math.sqrt(d.connections) * 4)
        .attr('fill', d => `url(#glow-${d.type})`)
        .style('opacity', 0.5);

      // Main node circles
      node.append('circle')
        .attr('class', 'node-core')
        .attr('r', d => 5 + Math.sqrt(d.connections) * 2)
        .attr('fill', d => typeColors[d.type] || '#666')
        .attr('stroke', 'rgba(255,255,255,0.8)')
        .attr('stroke-width', 1.5);

      // Node labels
      node.append('text')
        .text(d => d.label.length > 30 ? d.label.substring(0, 30) + '...' : d.label)
        .attr('x', d => 10 + Math.sqrt(d.connections) * 2)
        .attr('y', 4)
        .attr('class', 'node-label')
        .style('font-family', "'Space Grotesk', sans-serif")
        .style('font-size', '11px')
        .style('font-weight', '500')
        .style('fill', 'var(--color-text-primary, #141414)')
        .style('opacity', 0)
        .style('pointer-events', 'none');

      // Interactions
      node.on('mouseenter', function(event, d) {
        d3.select(this).select('.node-label').style('opacity', 1);
        d3.select(this).select('.node-core')
          .transition().duration(150)
          .attr('r', d => 7 + Math.sqrt(d.connections) * 2)
          .attr('stroke', '#fff')
          .attr('stroke-width', 2);
        d3.select(this).select('.node-glow')
          .transition().duration(150)
          .style('opacity', 0.8);

        // Highlight connected edges
        link.style('stroke-opacity', l =>
          (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.1
        );
      }).on('mouseleave', function(event, d) {
        d3.select(this).select('.node-label').style('opacity', 0);
        d3.select(this).select('.node-core')
          .transition().duration(150)
          .attr('r', d => 5 + Math.sqrt(d.connections) * 2)
          .attr('stroke', 'rgba(255,255,255,0.3)')
          .attr('stroke-width', 1.5);
        d3.select(this).select('.node-glow')
          .transition().duration(150)
          .style('opacity', 0.5);

        link.style('stroke-opacity', l => l.type === 'tag' ? 0.4 : 0.6);
      });

      node.on('click', (event, d) => {
        event.stopPropagation();
        showNodeDetails(d, data, typeColors);
      });

      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);
        node.attr('transform', d => `translate(${d.x},${d.y})`);
      });

      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
      }
      function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null; d.fy = null;
      }

      // Type filter buttons
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const selectedType = btn.dataset.type;

          node.transition().duration(300).style('opacity', d =>
            selectedType === 'all' || d.type === selectedType ? 1 : 0.1
          );
          link.transition().duration(300).style('opacity', d => {
            if (selectedType === 'all') return d.type === 'tag' ? 0.5 : 0.6;
            const sourceMatch = d.source.type === selectedType;
            const targetMatch = d.target.type === selectedType;
            return (sourceMatch || targetMatch) ? 0.6 : 0.02;
          });
        });
      });

      document.getElementById('showRelated').addEventListener('change', (e) => {
        d3.selectAll('.edge-related').transition().duration(300)
          .style('display', e.target.checked ? 'block' : 'none');
      });

      document.getElementById('showTags').addEventListener('change', (e) => {
        d3.selectAll('.edge-tag').transition().duration(300)
          .style('display', e.target.checked ? 'block' : 'none');
      });

      document.getElementById('resetView').addEventListener('click', () => {
        svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.type-btn[data-type="all"]').classList.add('active');
        node.transition().duration(300).style('opacity', 1);
        link.transition().duration(300).style('opacity', d => d.type === 'tag' ? 0.5 : 0.6);
      });

      document.getElementById('closeDetails').addEventListener('click', () => {
        document.getElementById('node-details').classList.add('hidden');
      });

      svg.on('click', () => {
        document.getElementById('node-details').classList.add('hidden');
      });

      window.addEventListener('resize', () => {
        width = container.clientWidth;
        height = Math.max(600, window.innerHeight - 200);
        svg.attr('width', width).attr('height', height);
        simulation.force('center', d3.forceCenter(width / 2, height / 2));
        simulation.alpha(0.3).restart();
      });
    }

    function showNodeDetails(d, data, typeColors) {
      const panel = document.getElementById('node-details');

      document.getElementById('detail-type').textContent = d.type;
      document.getElementById('detail-type').style.background = typeColors[d.type];
      document.getElementById('detail-title').textContent = d.label;

      const tagsEl = document.getElementById('detail-tags');
      tagsEl.textContent = '';
      d.tags.slice(0, 4).forEach(tag => {
        const span = document.createElement('span');
        span.className = 'tag';
        span.textContent = tag;
        tagsEl.appendChild(span);
      });

      const connected = data.edges
        .filter(e => e.source.id === d.id || e.target.id === d.id)
        .map(e => e.source.id === d.id ? e.target : e.source);
      const uniqueConnected = [...new Map(connected.map(c => [c.id, c])).values()];

      const connEl = document.getElementById('detail-connections');
      connEl.textContent = '';

      const header = document.createElement('div');
      header.className = 'conn-header';
      header.textContent = `${uniqueConnected.length} connected posts`;
      connEl.appendChild(header);

      uniqueConnected.slice(0, 4).forEach(c => {
        const link = document.createElement('a');
        link.href = `/posts/${c.id}`;
        link.className = 'conn-link';
        link.textContent = c.label;
        connEl.appendChild(link);
      });

      document.getElementById('detail-link').href = `/posts/${d.id}`;
      panel.classList.remove('hidden');
    }
  </script>

  <style is:global>
    .graph-page {
      min-height: 100vh;
      background: var(--color-bg);
    }

    .graph-header {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.5rem 2rem;
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .graph-header .back-link {
      font-family: 'Space Mono', monospace;
      font-size: 0.7rem;
      color: var(--color-text-tertiary);
      text-decoration: none;
      transition: color 0.15s;
      white-space: nowrap;
    }

    .graph-header .back-link:hover { color: var(--orange); }

    .graph-header .header-content h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.75rem;
      font-weight: 700;
      margin: 0;
      color: var(--color-text-primary);
    }

    .graph-header .graph-subtitle {
      font-family: 'Space Mono', monospace;
      font-size: 0.7rem;
      color: var(--color-text-tertiary);
      margin: 0.25rem 0 0;
    }

    .graph-header .stat { color: var(--orange); font-weight: 700; }

    .graph-layout {
      display: grid !important;
      grid-template-columns: 220px 1fr !important;
      gap: 0 !important;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem 2rem;
    }

    .graph-sidebar {
      padding-right: 1.5rem;
      border-right: 1px solid var(--color-border);
    }

    .graph-sidebar .sidebar-section {
      margin-bottom: 2rem;
    }

    .graph-sidebar .sidebar-section h3 {
      font-family: 'Space Mono', monospace;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-tertiary);
      margin: 0 0 0.75rem;
    }

    .graph-sidebar .type-filters {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .graph-sidebar .type-btn {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.5rem 0.75rem;
      background: transparent;
      border: none;
      border-radius: 6px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 0.8rem;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      text-align: left;
      width: 100%;
    }

    .graph-sidebar .type-btn:hover {
      background: var(--color-surface);
      color: var(--color-text-primary);
    }

    .graph-sidebar .type-btn.active {
      background: var(--color-surface);
      color: var(--color-text-primary);
      font-weight: 600;
    }

    .graph-sidebar .type-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .graph-sidebar .toggle-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0;
      cursor: pointer;
      font-size: 0.8rem;
      color: var(--color-text-secondary);
    }

    .graph-sidebar .toggle-label input {
      accent-color: var(--orange);
    }

    .graph-sidebar .toggle-line {
      width: 20px;
      height: 2px;
      border-radius: 1px;
      margin-left: auto;
    }

    .graph-sidebar .help-text {
      font-size: 0.75rem;
      color: var(--color-text-tertiary);
      line-height: 1.5;
      margin: 0 0 1rem;
    }

    .graph-sidebar .reset-btn {
      width: 100%;
      padding: 0.6rem;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-family: 'Space Mono', monospace;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .graph-sidebar .reset-btn:hover {
      background: var(--orange);
      border-color: var(--orange);
      color: white;
    }

    .graph-main {
      padding-left: 1.5rem;
    }

    .graph-container {
      position: relative;
      width: 100%;
      height: calc(100vh - 200px);
      min-height: 500px;
      border-radius: 12px;
      overflow: hidden;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
    }

    .graph-container .graph-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(ellipse at 20% 80%, rgba(217, 93, 15, 0.04) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 20%, rgba(109, 40, 217, 0.04) 0%, transparent 50%);
    }

    .graph-container #graph-svg {
      display: block;
      width: 100%;
      height: 100%;
    }

    /* Node details panel */
    .node-details {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 340px;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      z-index: 100;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .node-details.hidden {
      transform: translateY(20px) scale(0.95);
      opacity: 0;
      pointer-events: none;
    }

    .node-details .close-details {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: var(--color-surface);
      border-radius: 6px;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .node-details .close-details:hover {
      background: var(--color-border);
      color: var(--color-text-primary);
    }

    .node-details .detail-header {
      margin-bottom: 1rem;
      padding-right: 2rem;
    }

    .node-details .detail-type {
      display: inline-block;
      font-family: 'Space Mono', monospace;
      font-size: 0.6rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      color: white;
      margin-bottom: 0.5rem;
    }

    .node-details h3#detail-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      line-height: 1.3;
      margin: 0;
      color: #141414 !important;
    }

    .node-details .detail-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 1.25rem;
    }

    .node-details .detail-tags .tag {
      font-family: 'Space Mono', monospace;
      font-size: 0.65rem;
      padding: 0.2rem 0.5rem;
      background: var(--color-surface);
      border-radius: 4px;
      color: var(--color-text-secondary);
    }

    .node-details .detail-connections {
      margin-bottom: 1.25rem;
    }

    .node-details .conn-header {
      font-family: 'Space Mono', monospace;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--color-text-tertiary);
      margin-bottom: 0.6rem;
    }

    .node-details .conn-link {
      display: block;
      font-size: 0.85rem;
      color: var(--color-text-secondary);
      text-decoration: none;
      padding: 0.35rem 0;
      border-bottom: 1px solid var(--color-border);
      transition: color 0.15s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .node-details .conn-link:last-child { border-bottom: none; }
    .node-details .conn-link:hover { color: var(--orange); }

    .node-details .detail-cta {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-family: 'Space Mono', monospace;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--orange);
      text-decoration: none;
      transition: gap 0.2s;
    }

    .node-details .detail-cta:hover { gap: 0.75rem; }

    @media (max-width: 900px) {
      .graph-layout {
        grid-template-columns: 1fr !important;
        padding: 0 1rem 1rem;
      }

      .graph-sidebar {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        padding: 0 0 1rem;
        border-right: none;
        border-bottom: 1px solid var(--color-border);
        margin-bottom: 1rem;
      }

      .graph-sidebar .sidebar-section {
        margin-bottom: 0;
      }

      .graph-sidebar .type-filters {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .graph-main { padding-left: 0; }

      .graph-container { height: 60vh; min-height: 400px; }

      .node-details {
        bottom: 1rem;
        right: 1rem;
        left: 1rem;
        width: auto;
      }
    }

    @media (max-width: 600px) {
      .graph-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 1rem;
      }
    }
  </style>
</Base>
