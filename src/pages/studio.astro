---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Studio â€” Rabbit Holes</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,400;0,6..72,500;0,6..72,600;1,6..72,400;1,6..72,500&family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

  <!-- CodeMirror -->
  <script type="importmap">
  {
    "imports": {
      "codemirror": "https://esm.sh/codemirror@6.0.1",
      "@codemirror/lang-markdown": "https://esm.sh/@codemirror/lang-markdown@6.2.5",
      "@codemirror/state": "https://esm.sh/@codemirror/state@6.4.1",
      "@codemirror/view": "https://esm.sh/@codemirror/view@6.26.3",
      "@codemirror/commands": "https://esm.sh/@codemirror/commands@6.5.0",
      "@codemirror/language": "https://esm.sh/@codemirror/language@6.10.1",
      "@codemirror/theme-one-dark": "https://esm.sh/@codemirror/theme-one-dark@6.1.2",
      "marked": "https://esm.sh/marked@12.0.0"
    }
  }
  </script>

  <style>
    /* ========================================
       STUDIO DESIGN SYSTEM
       ======================================== */

    :root {
      /* Core palette - warm, sophisticated */
      --studio-bg: #FDFCFA;
      --studio-bg-subtle: #FAF9F7;
      --studio-surface: #F5F4F1;
      --studio-surface-raised: #FFFFFF;
      --studio-surface-hover: #EFEEEB;
      --studio-border: #E8E6E1;
      --studio-border-subtle: #F0EEEA;

      /* Text hierarchy */
      --studio-text: #1A1918;
      --studio-text-secondary: #5C5954;
      --studio-text-muted: #9C9890;
      --studio-text-faint: #C4C0B8;

      /* Accent colors */
      --studio-accent: #D95D0F;
      --studio-accent-hover: #C4540E;
      --studio-accent-subtle: rgba(217, 93, 15, 0.08);
      --studio-accent-muted: rgba(217, 93, 15, 0.15);

      /* Semantic colors */
      --studio-success: #15803D;
      --studio-success-subtle: rgba(21, 128, 61, 0.1);
      --studio-error: #DC2626;
      --studio-error-subtle: rgba(220, 38, 38, 0.1);
      --studio-warning: #D97706;
      --studio-info: #2563EB;

      /* Type colors */
      --type-musings: #D95D0F;
      --type-links: #2563EB;
      --type-reflections: #7C3AED;
      --type-verse: #9333EA;
      --type-practical: #15803D;

      /* Shadows - soft, layered */
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.03);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.04), 0 2px 4px rgba(0, 0, 0, 0.02);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.06), 0 4px 10px rgba(0, 0, 0, 0.03);
      --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.08), 0 8px 16px rgba(0, 0, 0, 0.04);
      --shadow-glow: 0 0 0 3px var(--studio-accent-subtle);

      /* Transitions */
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-in-out: cubic-bezier(0.45, 0, 0.55, 1);
      --duration-fast: 120ms;
      --duration-normal: 200ms;
      --duration-slow: 350ms;

      /* Spacing */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --space-16: 64px;

      /* Radius */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-xl: 20px;
      --radius-full: 9999px;

      /* Typography */
      --font-sans: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-serif: 'Newsreader', Georgia, serif;
      --font-mono: 'Space Mono', 'SF Mono', monospace;
    }

    /* Dark mode */
    [data-theme="dark"] {
      --studio-bg: #0C0C0B;
      --studio-bg-subtle: #111110;
      --studio-surface: #1A1918;
      --studio-surface-raised: #222120;
      --studio-surface-hover: #2A2928;
      --studio-border: #333230;
      --studio-border-subtle: #252423;

      --studio-text: #F5F4F2;
      --studio-text-secondary: #B5B3AE;
      --studio-text-muted: #7C7A74;
      --studio-text-faint: #4A4844;

      --studio-accent: #EA7E3C;
      --studio-accent-hover: #F59155;
      --studio-accent-subtle: rgba(234, 126, 60, 0.12);
      --studio-accent-muted: rgba(234, 126, 60, 0.2);

      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.2);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.25);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.4);
      --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    /* ========================================
       BASE STYLES
       ======================================== */

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: var(--font-sans);
      background: var(--studio-bg);
      color: var(--studio-text);
      line-height: 1.5;
      min-height: 100vh;
      overflow-x: hidden;
    }

    button {
      font-family: inherit;
      cursor: pointer;
      border: none;
      background: none;
    }

    input, textarea {
      font-family: inherit;
      border: none;
      outline: none;
      background: transparent;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* ========================================
       LOGIN SCREEN
       ======================================== */

    .login-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--studio-bg);
      z-index: 1000;
      opacity: 1;
      transition: opacity var(--duration-slow) var(--ease-out);
    }

    .login-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .login-ambient {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
    }

    .login-ambient::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background:
        radial-gradient(ellipse at 30% 20%, var(--studio-accent-subtle) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(124, 58, 237, 0.04) 0%, transparent 40%);
      /* Static gradient - animation removed for cleaner aesthetic */
    }

    .login-card {
      position: relative;
      width: 100%;
      max-width: 380px;
      margin: var(--space-4);
      padding: var(--space-10);
      background: var(--studio-surface-raised);
      border: 1px solid var(--studio-border-subtle);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
    }

    .login-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      margin-bottom: var(--space-8);
    }

    .login-logo svg {
      width: 32px;
      height: 32px;
      color: var(--studio-accent);
    }

    .login-logo span {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .login-title {
      text-align: center;
      margin-bottom: var(--space-6);
    }

    .login-title h1 {
      font-size: 1.125rem;
      font-weight: 500;
      color: var(--studio-text-secondary);
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .login-input-wrap {
      position: relative;
    }

    .login-input {
      width: 100%;
      height: 52px;
      padding: 0 var(--space-4);
      font-size: 1rem;
      color: var(--studio-text);
      background: var(--studio-surface);
      border: 1px solid var(--studio-border);
      border-radius: var(--radius-md);
      transition: all var(--duration-normal) var(--ease-out);
    }

    .login-input::placeholder {
      color: var(--studio-text-muted);
    }

    .login-input:focus {
      background: var(--studio-surface-raised);
      border-color: var(--studio-accent);
      box-shadow: var(--shadow-glow);
    }

    .login-btn {
      height: 52px;
      font-size: 0.9375rem;
      font-weight: 600;
      color: white;
      background: var(--studio-accent);
      border-radius: var(--radius-md);
      transition: all var(--duration-normal) var(--ease-out);
    }

    .login-btn:hover {
      background: var(--studio-accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .login-error {
      padding: var(--space-3) var(--space-4);
      font-size: 0.875rem;
      color: var(--studio-error);
      background: var(--studio-error-subtle);
      border-radius: var(--radius-sm);
      text-align: center;
      display: none;
    }

    .login-error.visible {
      display: block;
      animation: shake 0.4s var(--ease-out);
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-4px); }
      80% { transform: translateX(4px); }
    }

    /* ========================================
       APP SHELL
       ======================================== */

    .app {
      display: none;
      flex-direction: column;
      min-height: 100vh;
    }

    .app.visible {
      display: flex;
      animation: fadeIn var(--duration-slow) var(--ease-out);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Header - refined for minimal aesthetic */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 52px;
      padding: 0 var(--space-4);
      background: var(--studio-bg);
      border-bottom: 1px solid var(--studio-border-subtle);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: 1.125rem;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .header-logo svg {
      width: 24px;
      height: 24px;
      color: var(--studio-accent);
    }

    /* Desktop Nav */
    .header-nav {
      display: none;
      align-items: center;
      gap: var(--space-1);
      margin-left: var(--space-6);
    }

    @media (min-width: 768px) {
      .header-nav {
        display: flex;
      }
    }

    .nav-btn {
      padding: var(--space-2) var(--space-3);
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--studio-text-secondary);
      border-radius: var(--radius-sm);
      transition: all var(--duration-fast) var(--ease-out);
    }

    .nav-btn:hover {
      color: var(--studio-text);
      background: var(--studio-surface-hover);
    }

    .nav-btn.active {
      color: var(--studio-text);
      background: var(--studio-surface);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .header-icon-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      color: var(--studio-text-muted);
      border-radius: var(--radius-sm);
      transition: all var(--duration-fast) var(--ease-out);
    }

    .header-icon-btn:hover {
      color: var(--studio-text);
      background: var(--studio-surface);
    }

    .header-icon-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Mobile menu button */
    .mobile-menu-btn {
      display: flex;
    }

    @media (min-width: 768px) {
      .mobile-menu-btn {
        display: none;
      }
    }

    /* Mobile nav drawer */
    .mobile-nav {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 200;
    }

    .mobile-nav.open {
      display: block;
    }

    .mobile-nav-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      animation: fadeIn var(--duration-normal) var(--ease-out);
    }

    .mobile-nav-drawer {
      position: absolute;
      top: 0;
      right: 0;
      width: 280px;
      height: 100%;
      background: var(--studio-surface-raised);
      box-shadow: var(--shadow-xl);
      padding: var(--space-5);
      animation: slideIn var(--duration-normal) var(--ease-out);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .mobile-nav-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
    }

    .mobile-nav-title {
      font-weight: 600;
    }

    .mobile-nav-close {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--studio-text-muted);
      border-radius: var(--radius-sm);
    }

    .mobile-nav-links {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .mobile-nav-link {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      font-weight: 500;
      color: var(--studio-text-secondary);
      border-radius: var(--radius-md);
      transition: all var(--duration-fast);
    }

    .mobile-nav-link:hover,
    .mobile-nav-link.active {
      color: var(--studio-text);
      background: var(--studio-surface);
    }

    .mobile-nav-link svg {
      width: 20px;
      height: 20px;
      color: var(--studio-text-muted);
    }

    /* ========================================
       MAIN CONTENT AREA
       ======================================== */

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .view {
      display: none;
      flex: 1;
      flex-direction: column;
    }

    .view.active {
      display: flex;
    }

    /* ========================================
       POSTS VIEW
       ======================================== */

    .posts-view {
      padding: var(--space-5);
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }

    .posts-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-6);
    }

    .posts-title {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .new-post-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      font-size: 0.875rem;
      font-weight: 600;
      color: white;
      background: var(--studio-accent);
      border-radius: var(--radius-md);
      transition: all var(--duration-normal) var(--ease-out);
    }

    .new-post-btn:hover {
      background: var(--studio-accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .new-post-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Search */
    .posts-search {
      position: relative;
      margin-bottom: var(--space-5);
    }

    .posts-search-icon {
      position: absolute;
      left: var(--space-4);
      top: 50%;
      transform: translateY(-50%);
      color: var(--studio-text-muted);
      pointer-events: none;
    }

    .posts-search-icon svg {
      width: 18px;
      height: 18px;
    }

    .posts-search-input {
      width: 100%;
      height: 44px;
      padding: 0 var(--space-4) 0 44px;
      font-size: 0.9375rem;
      color: var(--studio-text);
      background: var(--studio-surface);
      border: 1px solid var(--studio-border-subtle);
      border-radius: var(--radius-md);
      transition: all var(--duration-normal) var(--ease-out);
    }

    .posts-search-input::placeholder {
      color: var(--studio-text-muted);
    }

    .posts-search-input:focus {
      background: var(--studio-surface-raised);
      border-color: var(--studio-border);
      box-shadow: var(--shadow-sm);
    }

    /* Posts list */
    .posts-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .posts-group-label {
      font-family: var(--font-mono);
      font-size: 0.6875rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--studio-text-muted);
      padding: var(--space-4) 0 var(--space-2);
    }

    .post-card {
      display: flex;
      align-items: flex-start;
      gap: var(--space-4);
      padding: var(--space-4);
      background: var(--studio-surface-raised);
      border: 1px solid var(--studio-border-subtle);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-normal) var(--ease-out);
    }

    .post-card:hover {
      border-color: var(--studio-border);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .post-card-content {
      flex: 1;
      min-width: 0;
    }

    .post-card-meta {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-1);
    }

    .post-card-type {
      font-family: var(--font-mono);
      font-size: 0.625rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .post-card-type.musings { color: var(--type-musings); }
    .post-card-type.links { color: var(--type-links); }
    .post-card-type.reflections { color: var(--type-reflections); }
    .post-card-type.verse { color: var(--type-verse); }
    .post-card-type.practical { color: var(--type-practical); }

    .post-card-date {
      font-family: var(--font-mono);
      font-size: 0.6875rem;
      color: var(--studio-text-muted);
    }

    .post-card-title {
      font-size: 1rem;
      font-weight: 500;
      color: var(--studio-text);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .post-card-arrow {
      color: var(--studio-text-faint);
      flex-shrink: 0;
      transition: transform var(--duration-fast);
    }

    .post-card:hover .post-card-arrow {
      color: var(--studio-text-muted);
      transform: translateX(2px);
    }

    .post-card-arrow svg {
      width: 16px;
      height: 16px;
    }

    /* Empty state */
    .posts-empty {
      text-align: center;
      padding: var(--space-16) var(--space-4);
      color: var(--studio-text-muted);
    }

    .posts-empty-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto var(--space-4);
      color: var(--studio-text-faint);
    }

    .posts-empty h3 {
      font-size: 1rem;
      font-weight: 500;
      color: var(--studio-text-secondary);
      margin-bottom: var(--space-2);
    }

    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(
        90deg,
        var(--studio-surface) 25%,
        var(--studio-surface-hover) 50%,
        var(--studio-surface) 75%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-sm);
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .post-card-skeleton {
      height: 76px;
      border-radius: var(--radius-md);
    }

    /* ========================================
       EDITOR VIEW
       ======================================== */

    .editor-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 60px);
      overflow: hidden;
    }

    .editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) var(--space-5);
      background: var(--studio-bg);
      border-bottom: 1px solid var(--studio-border-subtle);
    }

    .editor-back {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--studio-text-secondary);
      padding: var(--space-2);
      margin-left: calc(-1 * var(--space-2));
      border-radius: var(--radius-sm);
      transition: color var(--duration-fast);
    }

    .editor-back:hover {
      color: var(--studio-text);
    }

    .editor-back svg {
      width: 16px;
      height: 16px;
    }

    .editor-status {
      font-family: var(--font-mono);
      font-size: 0.6875rem;
      color: var(--studio-text-muted);
      transition: color var(--duration-normal) var(--ease-out);
    }

    .editor-status.saved {
      color: var(--studio-success);
    }

    .editor-status.saving {
      color: var(--studio-accent);
    }

    .editor-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .editor-btn {
      padding: var(--space-2) var(--space-4);
      font-size: 0.8125rem;
      font-weight: 600;
      border-radius: var(--radius-sm);
      transition: all var(--duration-fast);
    }

    .editor-btn-secondary {
      color: var(--studio-text-secondary);
      background: var(--studio-surface);
    }

    .editor-btn-secondary:hover {
      background: var(--studio-surface-hover);
      color: var(--studio-text);
    }

    .editor-btn-primary {
      color: white;
      background: var(--studio-accent);
    }

    .editor-btn-primary:hover {
      background: var(--studio-accent-hover);
    }

    .editor-btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Editor content */
    .editor-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    @media (min-width: 1024px) {
      .editor-content {
        flex-direction: row;
      }
    }

    /* Title area */
    .editor-title-area {
      padding: var(--space-5);
      background: var(--studio-bg);
      border-bottom: 1px solid var(--studio-border-subtle);
    }

    .editor-title-input {
      width: 100%;
      font-family: var(--font-sans);
      font-size: 1.5rem;
      font-weight: 600;
      line-height: 1.3;
      color: var(--studio-text);
      letter-spacing: -0.02em;
    }

    .editor-title-input::placeholder {
      color: var(--studio-text-muted);
    }

    @media (min-width: 768px) {
      .editor-title-input {
        font-size: 1.75rem;
      }
    }

    /* Meta row */
    .editor-meta-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--space-2);
      margin-top: var(--space-4);
    }

    .editor-type-select {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--studio-text-secondary);
      background: var(--studio-surface);
      border: 1px solid var(--studio-border-subtle);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all var(--duration-fast);
    }

    .editor-type-select:hover {
      border-color: var(--studio-border);
    }

    .type-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .type-dot.musings { background: var(--type-musings); }
    .type-dot.links { background: var(--type-links); }
    .type-dot.reflections { background: var(--type-reflections); }
    .type-dot.verse { background: var(--type-verse); }
    .type-dot.practical { background: var(--type-practical); }

    .editor-tags {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--space-2);
    }

    .editor-tag {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-3);
      font-size: 0.8125rem;
      color: var(--studio-text-secondary);
      background: var(--studio-surface);
      border-radius: var(--radius-full);
    }

    .editor-tag-remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      color: var(--studio-text-muted);
      transition: color var(--duration-fast);
    }

    .editor-tag-remove:hover {
      color: var(--studio-error);
    }

    .editor-add-tag {
      padding: var(--space-1) var(--space-3);
      font-size: 0.8125rem;
      color: var(--studio-text-muted);
      border: 1px dashed var(--studio-border);
      border-radius: var(--radius-full);
      transition: all var(--duration-fast);
    }

    .editor-add-tag:hover {
      color: var(--studio-text-secondary);
      border-color: var(--studio-text-muted);
    }

    /* Inline tag input - replaces browser prompt() */
    .tag-input-wrap {
      display: flex;
      align-items: center;
    }

    .tag-input-inline {
      display: none;
      width: 120px;
      padding: var(--space-1) var(--space-3);
      font-size: 0.8125rem;
      color: var(--studio-text);
      background: var(--studio-surface-raised);
      border: 1px solid var(--studio-accent);
      border-radius: var(--radius-full);
      outline: none;
      transition: all var(--duration-fast);
    }

    .tag-input-inline::placeholder {
      color: var(--studio-text-muted);
    }

    .tag-input-inline.visible {
      display: block;
    }

    .tag-input-wrap.input-active .editor-add-tag {
      display: none;
    }

    /* Editor panels */
    .editor-panels {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    @media (min-width: 1024px) {
      .editor-panels {
        flex-direction: row;
      }
    }

    .editor-tabs {
      display: flex;
      border-bottom: 1px solid var(--studio-border-subtle);
    }

    @media (min-width: 1024px) {
      .editor-tabs {
        display: none;
      }
    }

    .editor-tab {
      flex: 1;
      padding: var(--space-3);
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--studio-text-muted);
      text-align: center;
      border-bottom: 2px solid transparent;
      transition: all var(--duration-fast);
    }

    .editor-tab.active {
      color: var(--studio-text);
      border-bottom-color: var(--studio-accent);
    }

    .editor-pane {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .editor-pane.active {
      display: flex;
    }

    @media (min-width: 1024px) {
      .editor-pane {
        display: flex;
        width: 50%;
      }

      .editor-pane.write-pane {
        border-right: 1px solid var(--studio-border-subtle);
      }
    }

    /* Pane headers hidden on desktop for cleaner aesthetic */
    .pane-header {
      display: none;
    }

    /* CodeMirror wrapper */
    #codemirror-wrapper {
      flex: 1;
      overflow: auto;
      font-size: 0.9375rem;
    }

    #codemirror-wrapper .cm-editor {
      height: 100%;
    }

    #codemirror-wrapper .cm-scroller {
      font-family: var(--font-mono);
      padding: var(--space-4);
    }

    #codemirror-wrapper .cm-content {
      font-family: var(--font-mono);
    }

    #codemirror-wrapper .cm-line {
      padding: 2px 0;
    }

    /* Preview pane */
    .preview-content {
      flex: 1;
      overflow: auto;
      padding: var(--space-5);
    }

    .preview-content h1,
    .preview-content h2,
    .preview-content h3 {
      font-family: var(--font-sans);
      font-weight: 600;
      line-height: 1.3;
      margin-top: 1.5em;
      margin-bottom: 0.5em;
    }

    .preview-content h1 { font-size: 1.5rem; }
    .preview-content h2 { font-size: 1.25rem; }
    .preview-content h3 { font-size: 1.125rem; }

    .preview-content p {
      font-family: var(--font-serif);
      font-size: 1.0625rem;
      line-height: 1.7;
      margin-bottom: 1em;
      color: var(--studio-text-secondary);
    }

    .preview-content a {
      color: var(--studio-accent);
      text-decoration: underline;
    }

    .preview-content ul,
    .preview-content ol {
      font-family: var(--font-serif);
      padding-left: 1.5em;
      margin-bottom: 1em;
    }

    .preview-content li {
      margin-bottom: 0.25em;
    }

    .preview-content blockquote {
      font-family: var(--font-serif);
      font-style: italic;
      border-left: 3px solid var(--studio-border);
      padding-left: var(--space-4);
      margin: 1.5em 0;
      color: var(--studio-text-secondary);
    }

    .preview-content code {
      font-family: var(--font-mono);
      font-size: 0.875em;
      padding: 2px 6px;
      background: var(--studio-surface);
      border-radius: 4px;
    }

    .preview-content pre {
      font-family: var(--font-mono);
      font-size: 0.875rem;
      padding: var(--space-4);
      background: var(--studio-surface);
      border-radius: var(--radius-md);
      overflow-x: auto;
      margin-bottom: 1em;
    }

    .preview-content pre code {
      padding: 0;
      background: none;
    }

    .preview-placeholder {
      text-align: center;
      padding: var(--space-16);
      color: var(--studio-text-muted);
    }

    /* ========================================
       AI TOOLS PANEL
       ======================================== */

    .ai-panel {
      border-top: 1px solid var(--studio-border-subtle);
      background: var(--studio-bg-subtle);
    }

    .ai-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
    }

    .ai-panel-title {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--studio-text-secondary);
    }

    .ai-panel-title svg {
      width: 16px;
      height: 16px;
      color: var(--studio-accent);
    }

    .ai-panel-toggle {
      color: var(--studio-text-muted);
      transition: transform var(--duration-fast);
    }

    .ai-panel.collapsed .ai-panel-toggle {
      transform: rotate(180deg);
    }

    .ai-panel-toggle svg {
      width: 16px;
      height: 16px;
    }

    .ai-panel-content {
      padding: 0 var(--space-4) var(--space-3);
    }

    .ai-panel.collapsed .ai-panel-content {
      display: none;
    }

    .ai-tools-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      margin-bottom: var(--space-2);
    }

    .ai-tool-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--studio-text-secondary);
      background: var(--studio-surface-raised);
      border: 1px solid var(--studio-border-subtle);
      border-radius: var(--radius-sm);
      transition: all var(--duration-fast);
    }

    .ai-tool-btn svg {
      flex-shrink: 0;
    }

    .ai-tool-btn:hover {
      border-color: var(--studio-border);
      color: var(--studio-text);
    }

    .ai-tool-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .ai-tool-btn.loading {
      position: relative;
      color: transparent;
    }

    .ai-tool-btn.loading::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      border: 2px solid var(--studio-border);
      border-top-color: var(--studio-accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .ai-prompt-input {
      width: 100%;
      padding: var(--space-3);
      font-size: 0.875rem;
      color: var(--studio-text);
      background: var(--studio-surface-raised);
      border: 1px solid var(--studio-border-subtle);
      border-radius: var(--radius-sm);
      resize: none;
      transition: all var(--duration-fast);
    }

    .ai-prompt-input:focus {
      border-color: var(--studio-border);
      box-shadow: var(--shadow-sm);
    }

    .ai-prompt-input::placeholder {
      color: var(--studio-text-muted);
    }

    /* ========================================
       DRAFTS VIEW
       ======================================== */

    .drafts-view {
      padding: var(--space-5);
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }

    .drafts-header {
      margin-bottom: var(--space-6);
    }

    .drafts-title {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      margin-bottom: var(--space-1);
    }

    .drafts-subtitle {
      font-size: 0.9375rem;
      color: var(--studio-text-muted);
    }

    .drafts-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .draft-card {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4);
      background: var(--studio-surface-raised);
      border: 1px solid var(--studio-border-subtle);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-normal) var(--ease-out);
    }

    .draft-card:hover {
      border-color: var(--studio-border);
      box-shadow: var(--shadow-md);
    }

    .draft-card-content {
      flex: 1;
      min-width: 0;
    }

    .draft-card-title {
      font-weight: 500;
      color: var(--studio-text);
      margin-bottom: var(--space-1);
    }

    .draft-card-meta {
      font-size: 0.8125rem;
      color: var(--studio-text-muted);
    }

    .draft-card-actions {
      display: flex;
      gap: var(--space-2);
    }

    .draft-action-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--studio-text-muted);
      border-radius: var(--radius-sm);
      transition: all var(--duration-fast);
    }

    .draft-action-btn:hover {
      background: var(--studio-surface);
      color: var(--studio-text);
    }

    .draft-action-btn.delete:hover {
      background: var(--studio-error-subtle);
      color: var(--studio-error);
    }

    .draft-action-btn svg {
      width: 16px;
      height: 16px;
    }

    .drafts-empty {
      text-align: center;
      padding: var(--space-16) var(--space-4);
      color: var(--studio-text-muted);
    }

    .drafts-empty-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto var(--space-4);
      color: var(--studio-text-faint);
    }

    /* ========================================
       TOASTS
       ======================================== */

    .toast-container {
      position: fixed;
      bottom: var(--space-5);
      right: var(--space-5);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .toast {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: var(--studio-surface-raised);
      border: 1px solid var(--studio-border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      animation: toastIn var(--duration-normal) var(--ease-out);
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
    }

    .toast.success {
      border-left: 3px solid var(--studio-success);
    }

    .toast.error {
      border-left: 3px solid var(--studio-error);
    }

    .toast-icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .toast.success .toast-icon { color: var(--studio-success); }
    .toast.error .toast-icon { color: var(--studio-error); }

    .toast-message {
      font-size: 0.875rem;
      color: var(--studio-text);
    }

    .toast-close {
      margin-left: auto;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--studio-text-muted);
      border-radius: var(--radius-sm);
      transition: color var(--duration-fast);
    }

    .toast-close:hover {
      color: var(--studio-text);
    }

    /* ========================================
       TYPE SELECTOR DROPDOWN
       ======================================== */

    .type-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: var(--space-2);
      min-width: 160px;
      background: var(--studio-surface-raised);
      border: 1px solid var(--studio-border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      z-index: 50;
      display: none;
    }

    .type-dropdown.open {
      display: block;
      animation: dropdownIn var(--duration-fast) var(--ease-out);
    }

    @keyframes dropdownIn {
      from {
        opacity: 0;
        transform: translateY(-4px);
      }
    }

    .type-option {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      font-size: 0.875rem;
      color: var(--studio-text-secondary);
      cursor: pointer;
      transition: background var(--duration-fast);
    }

    .type-option-text {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .type-option-name {
      font-weight: 500;
    }

    .type-option-desc {
      font-size: 0.6875rem;
      color: var(--studio-text-muted);
    }

    .type-option:hover {
      background: var(--studio-surface);
    }

    .type-option.selected {
      background: var(--studio-accent-subtle);
      color: var(--studio-accent);
    }

    /* ========================================
       TAG INPUT
       ======================================== */

    .tag-input-wrap {
      position: relative;
    }

    .tag-input-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: var(--space-2);
      min-width: 200px;
      max-height: 200px;
      overflow-y: auto;
      background: var(--studio-surface-raised);
      border: 1px solid var(--studio-border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 50;
      display: none;
    }

    .tag-input-dropdown.open {
      display: block;
    }

    .tag-input-field {
      padding: var(--space-1) var(--space-3);
      font-size: 0.8125rem;
      color: var(--studio-text);
      background: var(--studio-surface-raised);
      border: 1px solid var(--studio-border);
      border-radius: var(--radius-full);
      min-width: 100px;
    }

    .tag-input-field:focus {
      border-color: var(--studio-accent);
      outline: none;
    }

    .tag-suggestion {
      padding: var(--space-2) var(--space-3);
      font-size: 0.8125rem;
      color: var(--studio-text-secondary);
      cursor: pointer;
      transition: background var(--duration-fast);
    }

    .tag-suggestion:hover {
      background: var(--studio-surface);
    }

    /* ========================================
       IMAGE UPLOAD
       ======================================== */

    .upload-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .upload-overlay.visible {
      display: flex;
      animation: fadeIn var(--duration-normal) var(--ease-out);
    }

    .upload-zone {
      width: 90%;
      max-width: 500px;
      padding: var(--space-12);
      background: var(--studio-surface-raised);
      border: 2px dashed var(--studio-accent);
      border-radius: var(--radius-xl);
      text-align: center;
    }

    .upload-zone.dragover {
      background: var(--studio-accent-subtle);
      border-style: solid;
    }

    .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto var(--space-4);
      color: var(--studio-accent);
    }

    .upload-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: var(--space-2);
    }

    .upload-subtitle {
      font-size: 0.875rem;
      color: var(--studio-text-muted);
      margin-bottom: var(--space-4);
    }

    .upload-input {
      display: none;
    }

    .upload-btn {
      padding: var(--space-3) var(--space-6);
      font-size: 0.875rem;
      font-weight: 600;
      color: white;
      background: var(--studio-accent);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--duration-fast);
    }

    .upload-btn:hover {
      background: var(--studio-accent-hover);
    }

    .upload-progress {
      margin-top: var(--space-4);
      display: none;
    }

    .upload-progress.visible {
      display: block;
    }

    .upload-progress-bar {
      height: 4px;
      background: var(--studio-surface);
      border-radius: 2px;
      overflow: hidden;
    }

    .upload-progress-fill {
      height: 100%;
      background: var(--studio-accent);
      width: 0%;
      transition: width var(--duration-normal) var(--ease-out);
    }

    .upload-progress-text {
      font-size: 0.75rem;
      color: var(--studio-text-muted);
      margin-top: var(--space-2);
    }

    /* Editor toolbar with upload button */
    .editor-toolbar {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: var(--studio-surface);
      border-top: 1px solid var(--studio-border-subtle);
    }

    .toolbar-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      font-size: 0.8125rem;
      color: var(--studio-text-secondary);
      border-radius: var(--radius-sm);
      transition: all var(--duration-fast);
    }

    .toolbar-btn:hover {
      background: var(--studio-surface-hover);
      color: var(--studio-text);
    }

    .toolbar-btn svg {
      width: 16px;
      height: 16px;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-ambient"></div>
    <div class="login-card">
      <div class="login-logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <span>Studio</span>
      </div>
      <div class="login-title">
        <h1>Welcome back</h1>
      </div>
      <form class="login-form" id="loginForm">
        <div class="login-error" id="loginError">Invalid password</div>
        <div class="login-input-wrap">
          <input
            type="password"
            class="login-input"
            id="loginPassword"
            placeholder="Enter password"
            autocomplete="current-password"
            required
          />
        </div>
        <button type="submit" class="login-btn" id="loginBtn">
          Enter Studio
        </button>
      </form>
    </div>
  </div>

  <!-- App -->
  <div class="app" id="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <a href="/" class="header-logo">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
          </svg>
          <span>Studio</span>
        </a>
        <nav class="header-nav">
          <button class="nav-btn active" data-view="posts">Posts</button>
          <button class="nav-btn" data-view="editor">Write</button>
          <button class="nav-btn" data-view="drafts">Drafts</button>
        </nav>
      </div>
      <div class="header-right">
        <button class="header-icon-btn" id="themeToggle" title="Toggle theme">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
        </button>
        <button class="header-icon-btn mobile-menu-btn" id="mobileMenuBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Mobile Nav -->
    <div class="mobile-nav" id="mobileNav">
      <div class="mobile-nav-backdrop" id="mobileNavBackdrop"></div>
      <div class="mobile-nav-drawer">
        <div class="mobile-nav-header">
          <span class="mobile-nav-title">Navigation</span>
          <button class="mobile-nav-close" id="mobileNavClose">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        <div class="mobile-nav-links">
          <a href="#" class="mobile-nav-link active" data-view="posts">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
            Posts
          </a>
          <a href="#" class="mobile-nav-link" data-view="editor">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Write
          </a>
          <a href="#" class="mobile-nav-link" data-view="drafts">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
            Drafts
          </a>
          <a href="/" class="mobile-nav-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            Back to Blog
          </a>
        </div>
      </div>
    </div>

    <!-- Main -->
    <main class="main">
      <!-- Posts View -->
      <div class="view posts-view active" id="postsView">
        <div class="posts-header">
          <h1 class="posts-title">Your Posts</h1>
          <button class="new-post-btn" id="newPostBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            New Post
          </button>
        </div>

        <div class="posts-search">
          <span class="posts-search-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
          </span>
          <input
            type="text"
            class="posts-search-input"
            id="postsSearch"
            placeholder="Search posts..."
          />
        </div>

        <div class="posts-list" id="postsList">
          <!-- Posts will be loaded here -->
          <div class="skeleton post-card-skeleton"></div>
          <div class="skeleton post-card-skeleton"></div>
          <div class="skeleton post-card-skeleton"></div>
        </div>
      </div>

      <!-- Editor View -->
      <div class="view editor-view" id="editorView">
        <div class="editor-header">
          <button class="editor-back" id="editorBack">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
            Back
          </button>
          <span class="editor-status" id="editorStatus">Unsaved</span>
          <div class="editor-actions">
            <button class="editor-btn editor-btn-secondary" id="previewBtn">Preview</button>
            <button class="editor-btn editor-btn-primary" id="publishBtn" disabled>Publish</button>
          </div>
        </div>

        <div class="editor-content">
          <div class="editor-title-area">
            <input
              type="text"
              class="editor-title-input"
              id="editorTitle"
              placeholder="Your title..."
            />
            <div class="editor-meta-row">
              <div class="type-selector" style="position: relative;">
                <button class="editor-type-select" id="typeSelect">
                  <span class="type-dot musings"></span>
                  <span id="typeLabel">Musings</span>
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </button>
                <div class="type-dropdown" id="typeDropdown">
                  <div class="type-option selected" data-type="musings">
                    <span class="type-dot musings"></span>
                    <span class="type-option-text">
                      <span class="type-option-name">Musings</span>
                      <span class="type-option-desc">Quick thoughts</span>
                    </span>
                  </div>
                  <div class="type-option" data-type="links">
                    <span class="type-dot links"></span>
                    <span class="type-option-text">
                      <span class="type-option-name">Links</span>
                      <span class="type-option-desc">Curated links</span>
                    </span>
                  </div>
                  <div class="type-option" data-type="reflections">
                    <span class="type-dot reflections"></span>
                    <span class="type-option-text">
                      <span class="type-option-name">Reflections</span>
                      <span class="type-option-desc">Deep dives</span>
                    </span>
                  </div>
                  <div class="type-option" data-type="verse">
                    <span class="type-dot verse"></span>
                    <span class="type-option-text">
                      <span class="type-option-name">Verse</span>
                      <span class="type-option-desc">Poetry</span>
                    </span>
                  </div>
                  <div class="type-option" data-type="practical">
                    <span class="type-dot practical"></span>
                    <span class="type-option-text">
                      <span class="type-option-name">Practical</span>
                      <span class="type-option-desc">How-to guides</span>
                    </span>
                  </div>
                </div>
              </div>
              <div class="editor-tags" id="editorTags">
                <!-- Tags will be added here -->
              </div>
              <div class="tag-input-wrap" id="tagInputWrap">
                <button class="editor-add-tag" id="addTagBtn">+ Add tag</button>
                <input
                  type="text"
                  class="tag-input-inline"
                  id="tagInputInline"
                  placeholder="Add tags..."
                  autocomplete="off"
                />
              </div>
            </div>
          </div>

          <div class="editor-panels">
            <div class="editor-tabs">
              <button class="editor-tab active" data-pane="write">Write</button>
              <button class="editor-tab" data-pane="preview">Preview</button>
            </div>

            <div class="editor-pane write-pane active" id="writePane">
              <div class="pane-header">Write</div>
              <div id="codemirror-wrapper"></div>
            </div>

            <div class="editor-pane preview-pane" id="previewPane">
              <div class="pane-header">Preview</div>
              <div class="preview-content" id="previewContent">
                <p class="preview-placeholder">Start writing to see preview...</p>
              </div>
            </div>
          </div>

          <!-- Editor Toolbar -->
          <div class="editor-toolbar">
            <button class="toolbar-btn" id="uploadBtn" title="Upload Image">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
              </svg>
              Image
            </button>
          </div>

          <!-- AI Panel -->
          <div class="ai-panel" id="aiPanel">
            <div class="ai-panel-header">
              <div class="ai-panel-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                AI Tools
              </div>
              <span class="ai-panel-toggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="18 15 12 9 6 15"/>
                </svg>
              </span>
            </div>
            <div class="ai-panel-content">
              <div class="ai-tools-row">
                <button class="ai-tool-btn" id="aiEnhance">
                  <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                  Enhance
                </button>
                <button class="ai-tool-btn" id="aiRefine">
                  <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                  Refine
                </button>
                <button class="ai-tool-btn" id="aiTitle">
                  <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                  Title
                </button>
              </div>
              <textarea
                class="ai-prompt-input"
                id="aiPrompt"
                rows="1"
                placeholder="Custom instructions (optional)..."
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Drafts View -->
      <div class="view drafts-view" id="draftsView">
        <div class="drafts-header">
          <h1 class="drafts-title">Drafts</h1>
          <p class="drafts-subtitle">Your unsaved work</p>
        </div>
        <div class="drafts-list" id="draftsList">
          <!-- Drafts will be loaded here -->
        </div>
      </div>
    </main>
  </div>

  <!-- Upload Overlay -->
  <div class="upload-overlay" id="uploadOverlay">
    <div class="upload-zone" id="uploadZone">
      <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      <h3 class="upload-title">Upload Image</h3>
      <p class="upload-subtitle">Drag and drop or click to browse</p>
      <label class="upload-btn">
        Choose File
        <input type="file" class="upload-input" id="uploadInput" accept="image/*" />
      </label>
      <div class="upload-progress" id="uploadProgress">
        <div class="upload-progress-bar">
          <div class="upload-progress-fill" id="uploadProgressFill"></div>
        </div>
        <p class="upload-progress-text" id="uploadProgressText">Uploading...</p>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script type="module">
    import { marked } from 'marked';

    // ========================================
    // STATE
    // ========================================

    const state = {
      authenticated: false,
      sessionToken: null,
      currentView: 'posts',
      posts: [],
      drafts: [],
      editor: {
        id: null,
        title: '',
        content: '',
        type: 'musings',
        tags: [],
        isDirty: false,
        isEditing: false,
        sha: null
      },
      codemirror: null
    };

    // ========================================
    // DOM ELEMENTS
    // ========================================

    const $ = (id) => document.getElementById(id);
    const $$ = (selector) => document.querySelectorAll(selector);

    const elements = {
      loginScreen: $('loginScreen'),
      loginForm: $('loginForm'),
      loginPassword: $('loginPassword'),
      loginError: $('loginError'),
      loginBtn: $('loginBtn'),
      app: $('app'),
      themeToggle: $('themeToggle'),
      mobileMenuBtn: $('mobileMenuBtn'),
      mobileNav: $('mobileNav'),
      mobileNavBackdrop: $('mobileNavBackdrop'),
      mobileNavClose: $('mobileNavClose'),
      postsView: $('postsView'),
      editorView: $('editorView'),
      draftsView: $('draftsView'),
      postsList: $('postsList'),
      postsSearch: $('postsSearch'),
      newPostBtn: $('newPostBtn'),
      editorBack: $('editorBack'),
      editorStatus: $('editorStatus'),
      editorTitle: $('editorTitle'),
      typeSelect: $('typeSelect'),
      typeDropdown: $('typeDropdown'),
      typeLabel: $('typeLabel'),
      editorTags: $('editorTags'),
      addTagBtn: $('addTagBtn'),
      tagInputWrap: $('tagInputWrap'),
      tagInputInline: $('tagInputInline'),
      publishBtn: $('publishBtn'),
      previewContent: $('previewContent'),
      aiPanel: $('aiPanel'),
      aiEnhance: $('aiEnhance'),
      aiRefine: $('aiRefine'),
      aiTitle: $('aiTitle'),
      aiPrompt: $('aiPrompt'),
      draftsList: $('draftsList'),
      toastContainer: $('toastContainer'),
      uploadBtn: $('uploadBtn'),
      uploadOverlay: $('uploadOverlay'),
      uploadZone: $('uploadZone'),
      uploadInput: $('uploadInput'),
      uploadProgress: $('uploadProgress'),
      uploadProgressFill: $('uploadProgressFill'),
      uploadProgressText: $('uploadProgressText')
    };

    // ========================================
    // UTILITIES
    // ========================================

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }

    function formatTimeAgo(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return formatDate(dateStr);
    }

    function debounce(fn, ms) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), ms);
      };
    }

    function generateDraftId() {
      return 'draft_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function slugify(text) {
      return text
        .toLowerCase()
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
    }

    // ========================================
    // TOAST NOTIFICATIONS
    // ========================================

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const iconPath = type === 'success'
        ? '<polyline points="20 6 9 17 4 12"/>'
        : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>';

      toast.innerHTML = `
        <svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          ${iconPath}
        </svg>
        <span class="toast-message">${escapeHtml(message)}</span>
        <button class="toast-close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      `;

      elements.toastContainer.appendChild(toast);

      const close = () => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(10px)';
        setTimeout(() => toast.remove(), 200);
      };

      toast.querySelector('.toast-close').addEventListener('click', close);
      setTimeout(close, 4000);
    }

    // ========================================
    // THEME
    // ========================================

    function initTheme() {
      const savedTheme = localStorage.getItem('studio-theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = savedTheme || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('studio-theme', next);
    }

    // ========================================
    // AUTH
    // ========================================

    async function checkAuth() {
      const token = localStorage.getItem('studio-session');
      const expires = localStorage.getItem('studio-expires');

      if (token && expires && new Date(expires) > new Date()) {
        state.sessionToken = token;
        state.authenticated = true;
        showApp();
        loadPosts();
        loadDrafts();
      }
    }

    async function login(password) {
      elements.loginBtn.disabled = true;
      elements.loginBtn.textContent = 'Signing in...';

      try {
        const res = await fetch('/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await res.json();

        if (data.success) {
          localStorage.setItem('studio-session', data.sessionToken);
          localStorage.setItem('studio-expires', data.expiresAt);
          state.sessionToken = data.sessionToken;
          state.authenticated = true;
          elements.loginScreen.classList.add('hidden');
          setTimeout(() => {
            showApp();
            loadPosts();
            loadDrafts();
          }, 350);
        } else {
          elements.loginError.classList.add('visible');
          elements.loginPassword.focus();
        }
      } catch (err) {
        elements.loginError.textContent = 'Connection error';
        elements.loginError.classList.add('visible');
      } finally {
        elements.loginBtn.disabled = false;
        elements.loginBtn.textContent = 'Enter Studio';
      }
    }

    function showApp() {
      elements.app.classList.add('visible');
    }

    // ========================================
    // NAVIGATION
    // ========================================

    function showView(viewName) {
      state.currentView = viewName;

      // Update nav buttons
      $$('.nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === viewName);
      });
      $$('.mobile-nav-link').forEach(link => {
        link.classList.toggle('active', link.dataset.view === viewName);
      });

      // Show/hide views
      $$('.view').forEach(view => view.classList.remove('active'));
      $(`${viewName}View`).classList.add('active');

      // Close mobile nav
      elements.mobileNav.classList.remove('open');

      // Initialize editor if needed
      if (viewName === 'editor' && !state.codemirror) {
        initEditor();
      }
    }

    function openMobileNav() {
      elements.mobileNav.classList.add('open');
    }

    function closeMobileNav() {
      elements.mobileNav.classList.remove('open');
    }

    // ========================================
    // POSTS
    // ========================================

    async function loadPosts() {
      // Show loading state
      elements.postsList.innerHTML = `
        <div class="skeleton post-card-skeleton"></div>
        <div class="skeleton post-card-skeleton"></div>
        <div class="skeleton post-card-skeleton"></div>
      `;

      try {
        const res = await fetch('/posts?limit=100');
        const data = await res.json();

        if (data.success && data.posts) {
          state.posts = data.posts;
          renderPosts(data.posts);
        } else {
          throw new Error(data.error || 'Failed to load posts');
        }
      } catch (err) {
        console.error('Failed to load posts:', err);
        elements.postsList.innerHTML = `
          <div class="posts-empty">
            <svg class="posts-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <h3>Failed to load posts</h3>
            <p>${escapeHtml(err.message)}</p>
          </div>
        `;
      }
    }

    function renderPosts(posts) {
      if (posts.length === 0) {
        elements.postsList.innerHTML = `
          <div class="posts-empty">
            <svg class="posts-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
            </svg>
            <h3>No posts yet</h3>
            <p>Click "New Post" to start writing</p>
          </div>
        `;
        return;
      }

      // Group posts by date
      const groups = {};
      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

      posts.forEach(post => {
        let label;
        if (post.date === today) {
          label = 'Today';
        } else if (post.date === yesterday) {
          label = 'Yesterday';
        } else {
          const date = new Date(post.date);
          label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        if (!groups[label]) groups[label] = [];
        groups[label].push(post);
      });

      let html = '';

      for (const [label, groupPosts] of Object.entries(groups)) {
        html += `<div class="posts-group-label">${escapeHtml(label)}</div>`;

        groupPosts.forEach(post => {
          html += `
            <div class="post-card" data-slug="${escapeHtml(post.slug)}" data-sha="${escapeHtml(post.sha)}" data-date="${escapeHtml(post.date)}">
              <div class="post-card-content">
                <div class="post-card-meta">
                  <span class="post-card-type ${escapeHtml(post.type || 'musings')}">${escapeHtml((post.type || 'musings').toUpperCase())}</span>
                </div>
                <h3 class="post-card-title">${escapeHtml(post.title || post.slug)}</h3>
              </div>
              <span class="post-card-arrow">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </span>
            </div>
          `;
        });
      }

      elements.postsList.innerHTML = html;

      // Add click handlers
      elements.postsList.querySelectorAll('.post-card').forEach(card => {
        card.addEventListener('click', () => {
          const slug = card.dataset.slug;
          loadPost(slug);
        });
      });
    }

    async function loadPost(slug) {
      showToast('Loading post...');

      try {
        const res = await fetch(`/posts/${slug}`);
        const data = await res.json();

        if (data.success && data.post) {
          const post = data.post;

          state.editor.id = null; // Clear draft ID since this is a published post
          state.editor.title = post.title;
          state.editor.content = post.content;
          state.editor.type = post.type;
          state.editor.tags = post.tags || [];
          state.editor.isDirty = false;
          state.editor.isEditing = true;
          state.editor.sha = post.sha;
          state.editor.slug = post.slug;
          state.editor.date = post.date;

          elements.editorTitle.value = post.title;

          if (state.codemirror) {
            state.codemirror.dispatch({
              changes: { from: 0, to: state.codemirror.state.doc.length, insert: post.content }
            });
          }

          updateTypeDisplay();
          renderTags();
          updatePreview();

          // Update button text for editing
          elements.publishBtn.textContent = 'Update';
          elements.publishBtn.disabled = false;
          elements.editorStatus.textContent = 'Editing';

          showView('editor');
        } else {
          throw new Error(data.error || 'Failed to load post');
        }
      } catch (err) {
        console.error('Failed to load post:', err);
        showToast(err.message, 'error');
      }
    }

    // Search posts
    function filterPosts(query) {
      if (!query) {
        renderPosts(state.posts);
        return;
      }

      const q = query.toLowerCase();
      const filtered = state.posts.filter(post =>
        (post.title && post.title.toLowerCase().includes(q)) ||
        (post.slug && post.slug.toLowerCase().includes(q)) ||
        (post.type && post.type.toLowerCase().includes(q))
      );
      renderPosts(filtered);
    }

    const debouncedFilterPosts = debounce((q) => filterPosts(q), 200);

    // ========================================
    // DRAFTS
    // ========================================

    function loadDrafts() {
      const drafts = JSON.parse(localStorage.getItem('studio-drafts') || '[]');
      state.drafts = drafts;
      renderDrafts();
    }

    function renderDrafts() {
      if (state.drafts.length === 0) {
        elements.draftsList.innerHTML = `
          <div class="drafts-empty">
            <svg class="drafts-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
            <h3>No drafts yet</h3>
            <p>Drafts are automatically saved as you write</p>
          </div>
        `;
        return;
      }

      elements.draftsList.innerHTML = state.drafts.map(draft => `
        <div class="draft-card" data-id="${escapeHtml(draft.id)}">
          <div class="draft-card-content">
            <div class="draft-card-title">${escapeHtml(draft.title || 'Untitled')}</div>
            <div class="draft-card-meta">${formatTimeAgo(draft.updatedAt)}</div>
          </div>
          <div class="draft-card-actions">
            <button class="draft-action-btn edit" title="Edit">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </button>
            <button class="draft-action-btn delete" title="Delete">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
            </button>
          </div>
        </div>
      `).join('');

      // Add event listeners
      elements.draftsList.querySelectorAll('.draft-card').forEach(card => {
        const id = card.dataset.id;

        card.querySelector('.edit').addEventListener('click', (e) => {
          e.stopPropagation();
          loadDraft(id);
        });

        card.querySelector('.delete').addEventListener('click', (e) => {
          e.stopPropagation();
          deleteDraft(id);
        });

        card.addEventListener('click', () => loadDraft(id));
      });
    }

    function saveDraft() {
      if (!state.editor.title && !state.editor.content) return;

      const draft = {
        id: state.editor.id || generateDraftId(),
        title: state.editor.title,
        content: state.editor.content,
        type: state.editor.type,
        tags: state.editor.tags,
        updatedAt: new Date().toISOString()
      };

      state.editor.id = draft.id;

      const index = state.drafts.findIndex(d => d.id === draft.id);
      if (index >= 0) {
        state.drafts[index] = draft;
      } else {
        state.drafts.unshift(draft);
      }

      localStorage.setItem('studio-drafts', JSON.stringify(state.drafts));
      state.editor.isDirty = false;
      elements.editorStatus.textContent = 'Saved âœ“';
      elements.editorStatus.classList.remove('saving');
      elements.editorStatus.classList.add('saved');
    }

    function loadDraft(id) {
      const draft = state.drafts.find(d => d.id === id);
      if (!draft) return;

      state.editor.id = draft.id;
      state.editor.title = draft.title;
      state.editor.content = draft.content;
      state.editor.type = draft.type;
      state.editor.tags = draft.tags || [];
      state.editor.isDirty = false;

      elements.editorTitle.value = draft.title;
      if (state.codemirror) {
        state.codemirror.dispatch({
          changes: { from: 0, to: state.codemirror.state.doc.length, insert: draft.content }
        });
      }

      updateTypeDisplay();
      renderTags();
      updatePreview();

      showView('editor');
    }

    function deleteDraft(id) {
      if (!confirm('Delete this draft?')) return;
      state.drafts = state.drafts.filter(d => d.id !== id);
      localStorage.setItem('studio-drafts', JSON.stringify(state.drafts));
      renderDrafts();
      showToast('Draft deleted');
    }

    // Debounced save with visual feedback
    const _debouncedSave = debounce(saveDraft, 1500);
    const debouncedSaveDraft = () => {
      elements.editorStatus.textContent = 'Saving...';
      elements.editorStatus.classList.remove('saved');
      elements.editorStatus.classList.add('saving');
      _debouncedSave();
    };

    // ========================================
    // EDITOR
    // ========================================

    async function initEditor() {
      try {
        const { EditorView, keymap, placeholder } = await import('@codemirror/view');
        const { EditorState } = await import('@codemirror/state');
        const { markdown } = await import('@codemirror/lang-markdown');
        const { defaultKeymap, history, historyKeymap } = await import('@codemirror/commands');
        const { oneDark } = await import('@codemirror/theme-one-dark');

        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

        const theme = EditorView.theme({
          '&': {
            height: '100%',
            fontSize: '15px'
          },
          '.cm-scroller': {
            fontFamily: 'var(--font-mono)',
            padding: '16px'
          },
          '.cm-content': {
            caretColor: 'var(--studio-accent)'
          },
          '.cm-cursor': {
            borderLeftColor: 'var(--studio-accent)'
          },
          '&.cm-focused .cm-selectionBackground, ::selection': {
            backgroundColor: 'var(--studio-accent-subtle)'
          },
          '.cm-gutters': {
            display: 'none'
          }
        });

        state.codemirror = new EditorView({
          state: EditorState.create({
            doc: state.editor.content,
            extensions: [
              markdown(),
              history(),
              keymap.of([...defaultKeymap, ...historyKeymap]),
              placeholder('Start writing your markdown...'),
              theme,
              isDark ? oneDark : [],
              EditorView.updateListener.of(update => {
                if (update.docChanged) {
                  state.editor.content = update.state.doc.toString();
                  state.editor.isDirty = true;
                  elements.editorStatus.textContent = 'Unsaved';
                  elements.editorStatus.classList.remove('saved');
                  elements.publishBtn.disabled = !state.editor.title;
                  debouncedSaveDraft();
                  updatePreview();
                }
              })
            ]
          }),
          parent: $('codemirror-wrapper')
        });
      } catch (err) {
        console.error('Failed to initialize editor:', err);
        showToast('Failed to load editor', 'error');
      }
    }

    function resetEditor() {
      state.editor = {
        id: null,
        title: '',
        content: '',
        type: 'musings',
        tags: [],
        isDirty: false,
        isEditing: false,
        sha: null,
        slug: null,
        date: null
      };

      elements.editorTitle.value = '';
      if (state.codemirror) {
        state.codemirror.dispatch({
          changes: { from: 0, to: state.codemirror.state.doc.length, insert: '' }
        });
      }

      updateTypeDisplay();
      renderTags();
      elements.previewContent.innerHTML = '<p class="preview-placeholder">Start writing to see preview...</p>';
      elements.editorStatus.textContent = 'Unsaved';
      elements.editorStatus.classList.remove('saved');
      elements.publishBtn.disabled = true;
      elements.publishBtn.textContent = 'Publish';
    }

    function updateTypeDisplay() {
      const typeDot = elements.typeSelect.querySelector('.type-dot');
      typeDot.className = `type-dot ${state.editor.type}`;
      elements.typeLabel.textContent = state.editor.type.charAt(0).toUpperCase() + state.editor.type.slice(1);

      elements.typeDropdown.querySelectorAll('.type-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.type === state.editor.type);
      });
    }

    function renderTags() {
      elements.editorTags.innerHTML = state.editor.tags.map(tag => `
        <span class="editor-tag">
          ${escapeHtml(tag)}
          <button class="editor-tag-remove" data-tag="${escapeHtml(tag)}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </span>
      `).join('');

      elements.editorTags.querySelectorAll('.editor-tag-remove').forEach(btn => {
        btn.addEventListener('click', () => {
          const tag = btn.dataset.tag;
          state.editor.tags = state.editor.tags.filter(t => t !== tag);
          renderTags();
          debouncedSaveDraft();
        });
      });
    }

    function updatePreview() {
      if (!state.editor.content) {
        elements.previewContent.innerHTML = '<p class="preview-placeholder">Start writing to see preview...</p>';
        return;
      }

      const html = marked.parse(state.editor.content);
      elements.previewContent.innerHTML = html;
    }

    // ========================================
    // PUBLISHING
    // ========================================

    async function publish() {
      if (!state.editor.title || !state.editor.content) {
        showToast('Title and content are required', 'error');
        return;
      }

      const isUpdate = state.editor.isEditing && state.editor.sha;
      const buttonText = isUpdate ? 'Updating...' : 'Publishing...';

      elements.publishBtn.disabled = true;
      elements.publishBtn.textContent = buttonText;

      try {
        let res;

        if (isUpdate) {
          // Update existing post via PUT
          res = await fetch(`/posts/${state.editor.slug}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${state.sessionToken}`
            },
            body: JSON.stringify({
              title: state.editor.title,
              content: state.editor.content,
              type: state.editor.type,
              tags: state.editor.tags,
              date: state.editor.date,
              sha: state.editor.sha
            })
          });
        } else {
          // Create new post
          const today = new Date().toISOString().split('T')[0];
          const slug = slugify(state.editor.title);

          res = await fetch('/publish', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${state.sessionToken}`
            },
            body: JSON.stringify({
              title: state.editor.title,
              content: state.editor.content,
              type: state.editor.type,
              tags: state.editor.tags,
              date: today,
              slug: slug
            })
          });
        }

        const data = await res.json();

        if (data.success) {
          // Remove draft if it exists
          if (state.editor.id) {
            state.drafts = state.drafts.filter(d => d.id !== state.editor.id);
            localStorage.setItem('studio-drafts', JSON.stringify(state.drafts));
          }

          showToast(isUpdate ? 'Updated successfully!' : 'Published successfully!');
          resetEditor();
          showView('posts');
          loadPosts();
        } else {
          throw new Error(data.error || 'Failed to publish');
        }
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        elements.publishBtn.disabled = false;
        elements.publishBtn.textContent = state.editor.isEditing ? 'Update' : 'Publish';
      }
    }

    // ========================================
    // AI TOOLS
    // ========================================

    async function callAI(endpoint) {
      if (!state.editor.content) {
        showToast('Write some content first', 'error');
        return;
      }

      const btn = $(`ai${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)}`);
      btn.classList.add('loading');
      btn.disabled = true;

      try {
        const res = await fetch(`/${endpoint}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${state.sessionToken}`
          },
          body: JSON.stringify({
            content: state.editor.content,
            title: state.editor.title,
            prompt: elements.aiPrompt.value
          })
        });

        const data = await res.json();

        if (data.success) {
          if (endpoint === 'enhance' || endpoint === 'refine') {
            state.codemirror.dispatch({
              changes: { from: 0, to: state.codemirror.state.doc.length, insert: data.content }
            });
            showToast('Content updated');
          } else if (data.title) {
            state.editor.title = data.title;
            elements.editorTitle.value = data.title;
            showToast('Title generated');
          }
        } else {
          throw new Error(data.error || 'AI request failed');
        }
      } catch (err) {
        showToast(err.message, 'error');
      } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    }

    // ========================================
    // IMAGE UPLOAD
    // ========================================

    function showUploadOverlay() {
      elements.uploadOverlay.classList.add('visible');
      elements.uploadProgress.classList.remove('visible');
      elements.uploadProgressFill.style.width = '0%';
    }

    function hideUploadOverlay() {
      elements.uploadOverlay.classList.remove('visible');
      elements.uploadZone.classList.remove('dragover');
    }

    async function uploadImage(file) {
      if (!file || !file.type.startsWith('image/')) {
        showToast('Please select an image file', 'error');
        return;
      }

      elements.uploadProgress.classList.add('visible');
      elements.uploadProgressFill.style.width = '10%';
      elements.uploadProgressText.textContent = 'Uploading...';

      try {
        const formData = new FormData();
        formData.append('file', file);

        elements.uploadProgressFill.style.width = '30%';

        const res = await fetch('/upload', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${state.sessionToken}`
          },
          body: formData
        });

        elements.uploadProgressFill.style.width = '80%';

        const data = await res.json();

        if (data.success) {
          elements.uploadProgressFill.style.width = '100%';
          elements.uploadProgressText.textContent = 'Complete!';

          // Insert markdown image at cursor
          const markdown = `![${file.name}](${data.url})`;
          insertAtCursor(markdown);

          setTimeout(() => {
            hideUploadOverlay();
            showToast('Image uploaded!');
          }, 500);
        } else {
          throw new Error(data.error || 'Upload failed');
        }
      } catch (err) {
        console.error('Upload error:', err);
        elements.uploadProgress.classList.remove('visible');
        showToast(err.message, 'error');
      }
    }

    function insertAtCursor(text) {
      if (state.codemirror) {
        const pos = state.codemirror.state.selection.main.head;
        state.codemirror.dispatch({
          changes: { from: pos, insert: text + '\n' }
        });
        state.codemirror.focus();
      }
    }

    // Handle paste events for images
    function handlePaste(e) {
      const items = e.clipboardData?.items;
      if (!items) return;

      for (const item of items) {
        if (item.type.startsWith('image/')) {
          e.preventDefault();
          const file = item.getAsFile();
          if (file) {
            showUploadOverlay();
            uploadImage(file);
          }
          return;
        }
      }
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================

    // Login
    elements.loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      elements.loginError.classList.remove('visible');
      login(elements.loginPassword.value);
    });

    // Theme
    elements.themeToggle.addEventListener('click', toggleTheme);

    // Mobile nav
    elements.mobileMenuBtn.addEventListener('click', openMobileNav);
    elements.mobileNavBackdrop.addEventListener('click', closeMobileNav);
    elements.mobileNavClose.addEventListener('click', closeMobileNav);

    // Navigation
    $$('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => showView(btn.dataset.view));
    });

    $$('.mobile-nav-link[data-view]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        showView(link.dataset.view);
      });
    });

    // New post
    elements.newPostBtn.addEventListener('click', () => {
      resetEditor();
      showView('editor');
    });

    // Search posts
    elements.postsSearch.addEventListener('input', (e) => {
      debouncedFilterPosts(e.target.value);
    });

    // Editor back
    elements.editorBack.addEventListener('click', () => {
      showView('posts');
    });

    // Title input
    elements.editorTitle.addEventListener('input', (e) => {
      state.editor.title = e.target.value;
      state.editor.isDirty = true;
      elements.publishBtn.disabled = !e.target.value;
      debouncedSaveDraft();
    });

    // Type selector
    elements.typeSelect.addEventListener('click', () => {
      elements.typeDropdown.classList.toggle('open');
    });

    elements.typeDropdown.querySelectorAll('.type-option').forEach(opt => {
      opt.addEventListener('click', () => {
        state.editor.type = opt.dataset.type;
        updateTypeDisplay();
        elements.typeDropdown.classList.remove('open');
        debouncedSaveDraft();
      });
    });

    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.type-selector')) {
        elements.typeDropdown.classList.remove('open');
      }
    });

    // Add tag - inline input (replaces browser prompt)
    elements.addTagBtn.addEventListener('click', () => {
      elements.tagInputWrap.classList.add('input-active');
      elements.tagInputInline.classList.add('visible');
      elements.tagInputInline.focus();
    });

    elements.tagInputInline.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const value = elements.tagInputInline.value.trim();
        if (value) {
          // Support comma-separated tags
          const newTags = value.split(',').map(t => t.trim()).filter(t => t && !state.editor.tags.includes(t));
          if (newTags.length) {
            state.editor.tags.push(...newTags);
            renderTags();
            debouncedSaveDraft();
          }
        }
        elements.tagInputInline.value = '';
        elements.tagInputInline.classList.remove('visible');
        elements.tagInputWrap.classList.remove('input-active');
      } else if (e.key === 'Escape') {
        elements.tagInputInline.value = '';
        elements.tagInputInline.classList.remove('visible');
        elements.tagInputWrap.classList.remove('input-active');
      }
    });

    elements.tagInputInline.addEventListener('blur', () => {
      // Small delay to allow Enter key to process first
      setTimeout(() => {
        if (elements.tagInputInline.classList.contains('visible')) {
          elements.tagInputInline.value = '';
          elements.tagInputInline.classList.remove('visible');
          elements.tagInputWrap.classList.remove('input-active');
        }
      }, 100);
    });

    // Editor tabs (mobile)
    $$('.editor-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        $$('.editor-tab').forEach(t => t.classList.remove('active'));
        $$('.editor-pane').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        $(`${tab.dataset.pane}Pane`).classList.add('active');
      });
    });

    // AI panel toggle
    elements.aiPanel.querySelector('.ai-panel-header').addEventListener('click', () => {
      elements.aiPanel.classList.toggle('collapsed');
    });

    // AI buttons
    elements.aiEnhance.addEventListener('click', () => callAI('enhance'));
    elements.aiRefine.addEventListener('click', () => callAI('refine'));
    elements.aiTitle.addEventListener('click', () => callAI('metadata'));

    // Image upload
    elements.uploadBtn.addEventListener('click', showUploadOverlay);

    elements.uploadOverlay.addEventListener('click', (e) => {
      if (e.target === elements.uploadOverlay) {
        hideUploadOverlay();
      }
    });

    elements.uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      elements.uploadZone.classList.add('dragover');
    });

    elements.uploadZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      elements.uploadZone.classList.remove('dragover');
    });

    elements.uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      elements.uploadZone.classList.remove('dragover');
      const file = e.dataTransfer?.files[0];
      if (file) {
        uploadImage(file);
      }
    });

    elements.uploadInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) {
        uploadImage(file);
      }
      e.target.value = ''; // Reset for next upload
    });

    // Paste handler for images
    document.addEventListener('paste', handlePaste);

    // Publish
    elements.publishBtn.addEventListener('click', publish);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + S to save
      if ((e.metaKey || e.ctrlKey) && e.key === 's') {
        e.preventDefault();
        saveDraft();
        showToast('Draft saved');
      }

      // Cmd/Ctrl + Enter to publish
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter' && state.currentView === 'editor') {
        e.preventDefault();
        if (!elements.publishBtn.disabled) {
          publish();
        }
      }

      // Escape to close modals/menus
      if (e.key === 'Escape') {
        closeMobileNav();
        hideUploadOverlay();
        elements.typeDropdown.classList.remove('open');
      }
    });

    // ========================================
    // INIT
    // ========================================

    initTheme();
    checkAuth();
  </script>
</body>
</html>
