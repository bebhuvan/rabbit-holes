#!/bin/bash
# Git pre-commit hook to automatically optimize images
# This script runs before each commit to ensure images are optimized

echo "ğŸ” Checking for new or modified images..."

# Get list of staged image files
STAGED_IMAGES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(png|jpg|jpeg|webp)$' | grep '^public/images/')

if [ -n "$STAGED_IMAGES" ]; then
    echo "ğŸ–¼ï¸  Found staged image files:"
    echo "$STAGED_IMAGES"
    echo ""
    
    # Run image optimization
    echo "âš¡ Running automatic image optimization..."
    npm run optimize-images
    
    if [ $? -eq 0 ]; then
        echo "âœ… Image optimization complete"
        
        # Add optimized files back to staging
        for img in $STAGED_IMAGES; do
            if [ -f "$img" ]; then
                git add "$img"
                echo "ğŸ“ Re-staged: $img"
            fi
        done
        
        echo ""
        echo "ğŸ’¡ Tip: Images have been automatically optimized and re-staged"
    else
        echo "âŒ Image optimization failed"
        echo "ğŸ’¡ Tip: You can skip optimization with: git commit --no-verify"
        exit 1
    fi
else
    echo "âœ… No image files to optimize"
fi

echo "ğŸš€ Proceeding with commit..."